<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海翔花纸成本测算系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fee2e2',
                            100: '#fecaca',
                            200: '#fca5a5',
                            300: '#f87171',
                            400: '#ef4444',
                            500: '#dc2626',
                            600: '#b91c1c',
                            700: '#991b1b',
                            800: '#7f1d1d',
                            900: '#6b1a1a',
                            950: '#450a0a'
                        },
                        secondary: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                            950: '#450a0a'
                        },
                        success: '#059669',
                        warning: '#d97706',
                        error: '#b91c1c',
                        info: '#3b82f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    
    <script>
        // 金膜行计数器
        let goldFilmCounter = 1;
        
        // 添加金膜行
        function addGoldFilmRow() {
            const container = document.getElementById('goldFilmContainer');
            const newRow = document.createElement('div');
            newRow.className = 'gold-film-row mb-4';
            newRow.innerHTML = `
                <div class="flex items-center gap-2">
                    <input type="text" id="pdfGoldFilmName_${goldFilmCounter}" value="金膜${goldFilmCounter + 1}"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button type="button" onclick="addGoldFilmRow()" 
                            class="text-blue-500 hover:text-blue-700 focus:outline-none p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="removeGoldFilmRow(${goldFilmCounter})" 
                            class="text-red-500 hover:text-red-700 focus:outline-none p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- 金膜价格和金膜长度作为子框 -->
                <div class="grid grid-cols-2 gap-3 mt-3 bg-gray-50 p-3 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">金膜价格 (元/卷)</label>
                        <input type="number" id="pdfGoldFilmPrice_${goldFilmCounter}" step="0.01" min="0" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" inputmode="decimal">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">金膜长度 (米)</label>
                        <input type="number" id="pdfGoldFilmLength_${goldFilmCounter}" step="0.01" min="0" value="1200"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" inputmode="decimal">
                    </div>
                </div>
            `;
            
            // 将新行插入到容器的末尾
            container.appendChild(newRow);
            goldFilmCounter++;
        }
        
        // 移除金膜行
        function removeGoldFilmRow(index) {
            const rows = document.querySelectorAll('.gold-film-row');
            if (rows.length > 1) {
                // 更可靠的删除方式
                const rowToRemove = document.getElementById(`pdfGoldFilmName_${index}`);
                if (rowToRemove) {
                    const parentRow = rowToRemove.closest('.gold-film-row');
                    if (parentRow) {
                        parentRow.remove();
                        console.log(`成功删除金膜行 ${index}`);
                    }
                }
            } else {
                alert('至少需要保留一行金膜参数');
            }
        }
        
        // 切换计算过程显示/隐藏
        function toggleCalculationProcess() {
            const modal = document.getElementById('calculationProcessModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .file-drop-area {
                border: 2px dashed #e5e7eb;
                transition: all 0.3s ease;
                background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
            }
            .file-drop-area:hover, .file-drop-area.active {
                border-color: theme('colors.primary.500');
                background: linear-gradient(135deg, theme('colors.primary.50') 0%, #ffffff 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
            }
            .tab-btn.active {
                color: theme('colors.primary.600');
                border-bottom: 2px solid theme('colors.primary.500');
                background: theme('colors.primary.50');
            }
            .tab-pane {
                display: none;
            }
            .tab-pane.active {
                display: block;
                animation: fadeIn 0.4s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fadeIn {
                animation: fadeIn 0.4s ease-out;
            }
            .card {
                background: white;
                border-radius: 12px;
                box-shadow: theme('boxShadow.card');
                transition: all 0.3s ease;
                border: 1px solid #f3f4f6;
            }
            .card:hover {
                box-shadow: theme('boxShadow.card-hover');
                transform: translateY(-2px);
            }
            .input-field {
                transition: all 0.2s ease;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                background: white;
            }
            .input-field:focus {
                border-color: theme('colors.primary.500');
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
                outline: none;
            }
            .btn-primary {
                background: linear-gradient(135deg, theme('colors.primary.600') 0%, theme('colors.primary.700') 100%);
                color: white;
                border-radius: 8px;
                transition: all 0.2s ease;
                border: none;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .btn-primary:hover {
                background: linear-gradient(135deg, theme('colors.primary.700') 0%, theme('colors.primary.800') 100%);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }
            .btn-secondary {
                background: white;
                color: theme('colors.primary.600');
                border: 1px solid theme('colors.primary.300');
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            .btn-secondary:hover {
                background: theme('colors.primary.50');
                border-color: theme('colors.primary.500');
            }
            .gradient-bg {
                background: linear-gradient(135deg, theme('colors.primary.600') 0%, theme('colors.primary.800') 100%);
            }
            .gradient-text {
                background: linear-gradient(135deg, theme('colors.primary.600') 0%, theme('colors.primary.400') 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
        }
        
        /* 深色主题样式 */
        .dark-theme {
            color-scheme: dark;
        }
        
        .dark-theme .bg-white {
            background-color: #1f2937 !important;
        }
        
        .dark-theme .text-gray-900 {
            color: #f9fafb !important;
        }
        
        .dark-theme .text-gray-700 {
            color: #d1d5db !important;
        }
        
        .dark-theme .text-gray-600 {
            color: #9ca3af !important;
        }
        
        .dark-theme .text-gray-500 {
            color: #6b7280 !important;
        }
        
        .dark-theme .text-gray-400 {
            color: #4b5563 !important;
        }
        
        .dark-theme .border-gray-200 {
            border-color: #374151 !important;
        }
        
        .dark-theme .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        .dark-theme .bg-gray-50 {
            background-color: #111827 !important;
        }
        
        .dark-theme .bg-gray-100 {
            background-color: #1f2937 !important;
        }
        
        .dark-theme .file-drop-area {
            border-color: #374151 !important;
            background-color: #1f2937 !important;
        }
        
        .dark-theme .file-drop-area:hover,
        .dark-theme .file-drop-area.active {
            border-color: #3b82f6 !important;
            background-color: #1e3a8a !important;
        }
        
        .dark-theme .shadow-md,
        .dark-theme .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 现代化标题栏 -->
    <header class="sticky top-0 z-50 gradient-bg shadow-lg border-b border-primary-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- 左侧 Logo 和标题 -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center backdrop-blur-sm border border-white border-opacity-30 shadow-lg">
                        <i class="fa fa-calculator text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tight">海翔花纸成本测算系统</h1>
                        <p class="text-xs text-red-100">专业的花纸成本计算解决方案</p>
                    </div>
                </div>
                
                <!-- 右侧功能区域 -->
                <div class="flex items-center space-x-3">
                    <!-- 作者信息 -->
                    <div class="hidden md:flex items-center space-x-2 text-white text-sm bg-white bg-opacity-10 px-3 py-1 rounded-full backdrop-blur-sm">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-xs">
                            <i class="fa fa-user"></i>
                        </div>
                        <span>王健超</span>
                        <span class="text-red-200">|</span>
                        <i class="fa fa-phone text-red-200"></i>
                        <span>18875045758</span>
                    </div>
                    
                    <!-- 主题切换按钮 -->
                    <button onclick="toggleTheme()" class="bg-white bg-opacity-10 hover:bg-opacity-20 text-white p-2 rounded-lg transition-all duration-300 border border-white border-opacity-20 hover:border-opacity-30 shadow-md">
                        <i class="fa fa-moon-o"></i>
                    </button>
                    
                    <!-- 使用帮助按钮 -->
                    <button onclick="toggleHelpModal()" class="bg-white text-primary-700 hover:bg-primary-50 px-4 py-2 rounded-lg transition-all duration-300 font-medium shadow-md hover:shadow-lg flex items-center space-x-2">
                        <i class="fa fa-question-circle"></i>
                        <span>使用帮助</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 装饰性波浪效果 -->
        <div class="relative h-4 overflow-hidden">
            <div class="absolute bottom-0 left-0 right-0 h-8 bg-white" style="clip-path: polygon(0 100%, 100% 100%, 100% 0, 0 100%, 50% 50%);"></div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 标签页导航已移除 -->


        <!-- PDF文件计算 -->
        <div id="pdfContent" class="tab-pane active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左侧：PDF上传区域 -->
                <div class="lg:col-span-1">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fa fa-upload text-primary-500 mr-2"></i>
                            PDF文件上传
                        </h3>
                        
                        <div onclick="document.getElementById('pdfUpload').click()" 
                             class="file-drop-area rounded-xl p-12 text-center cursor-pointer hover:border-primary-500 transition-all duration-300 min-h-[300px] flex flex-col items-center justify-center">
                            <input type="file" id="pdfUpload" accept=".pdf" 
                                   onchange="handlePdfUpload(this)" class="hidden">
                            <div class="mb-4">
                                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fa fa-file-pdf-o text-3xl text-primary-500"></i>
                                </div>
                            </div>
                            <h4 class="text-gray-700 font-medium mb-2">点击或拖拽PDF文件到此处</h4>
                            <p class="text-gray-500 text-sm mb-3">支持 PDF 格式文件</p>
                            <div class="inline-block bg-primary-50 text-primary-700 px-3 py-1 rounded-full text-xs font-medium">
                                <i class="fa fa-exclamation-triangle mr-1"></i> 仅支持黑白文件上传
                            </div>
                        </div>
                        
                        <!-- PDF上传进度条 -->
                        <div id="pdfUploadProgress" class="hidden mt-4">
                            <div class="flex items-center justify-between mb-1">
                                <span id="pdfUploadProgressText" class="text-sm font-medium text-gray-700">上传中...</span>
                                <span id="pdfUploadProgressPercent" class="text-sm text-gray-500">0%</span>
                            </div>
                            <div class="w-full">
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="pdfUploadProgressBar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            
                            
                        </div>
                        
                        <div id="pdfInfo" class="hidden mt-4">
                            <div class="space-y-4">
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-1 min-w-0">
                                        <div id="pdfFileNameDisplay" class="text-sm font-medium text-gray-900 truncate cursor-pointer hover:text-primary" onclick="startEditPdfFileName()"></div>
                                        <div id="pdfFileNameEdit" class="hidden">
                                            <input type="text" id="pdfFileNameInput" 
                                                   class="w-full text-sm border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   onkeydown="if(event.key === 'Enter') { event.stopPropagation(); savePdfFileName(); }"
                                                   onblur="savePdfFileName();">
                                        </div>
                                        <p id="pdfFileSize" class="text-xs text-gray-500"></p>
                                    </div>
                                    <div class="flex items-center space-x-2 shrink-0">
                                        <button onclick="startEditPdfFileName()" class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded" title="编辑文件名">
                                            <i class="fa fa-pencil"></i>
                                        </button>
                                        <button onclick="removePdf()" class="text-red-500 hover:text-red-700 transition-colors p-1 rounded" title="删除PDF">
                                            <i class="fa fa-times-circle"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- PDF页面列表 -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-inner">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                        <i class="fa fa-file-text-o text-primary-500 mr-2"></i>
                                        PDF页面列表 (<span id="pdfPageCount">0</span>页)
                                    </h5>
                                    <div id="pdfPageList" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                        <!-- 页面列表项将在这里动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            
                            
                        </div>
                        
                        <div id="pdfInfoSection" class="mt-6 hidden">
                            <h4 class="text-md font-medium text-gray-900 mb-3">PDF信息</h4>
                            <div id="pdfDetails" class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">总页数：</span>
                                    <span id="pdfTotalPages" class="font-medium text-gray-900">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">当前页码：</span>
                                    <span id="pdfCurrentPage" class="font-medium text-gray-900">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">页面尺寸：</span>
                                    <span id="pdfPageSize" class="font-medium text-gray-900">-</span>
                                </div>
                            </div>
                            
                            
                            
                        </div>
                        
                        <!-- 计算参数 -->
                        <div id="calculationParameters" class="mt-6 hidden">
                            <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                                <i class="fa fa-sliders text-primary-500 mr-2"></i>
                                计算参数
                            </h4>
                            <div class="space-y-4">
                                <!-- 第一行：花纸排版数量和订单数量 -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">花纸排版数量 (个/版)</label>
                                        <input type="number" id="pdfLayoutCountInput" step="1" min="1" value="20"
                                               class="input-field w-full px-3 py-2" inputmode="numeric">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">订单数量 (个)</label>
                                        <input type="number" id="pdfOrderCount" step="1" min="1" value="10000"
                                               class="input-field w-full px-3 py-2" inputmode="numeric">
                                    </div>
                                </div>
                                
                                <!-- 第二行：纸张单价和人工水电 -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">纸张单价 (元/张)</label>
                                        <input type="number" id="pdfPaperPrice" step="0.01" min="0" value="1"
                                               class="input-field w-full px-3 py-2" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">人工水电 (元)</label>
                                        <input type="number" id="pdfLaborCost" step="0.01" min="0" value="2"
                                               class="input-field w-full px-3 py-2" inputmode="decimal">
                                    </div>
                                </div>
                                
                                <!-- 第三行：纸张放数 -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">纸张放数</label>
                                        <input type="number" id="pdfPaperMultiplier" step="0.01" min="0" value="1.03"
                                               class="input-field w-full px-3 py-2" inputmode="decimal">
                                    </div>
                                </div>
                                
                                <!-- 金膜参数区域 -->
                                <div class="space-y-3">
                                    <!-- 金膜名称 -->
                                    <!-- 金膜名称 -->
                                    <div id="goldFilmContainer">
                                        <div class="flex items-center gap-2 mb-1">
                                            <label class="block text-sm font-medium text-gray-700">金膜名称</label>
                                        </div>
                                        
                                        <!-- 金膜参数行 -->
                                        <div class="gold-film-row mb-4 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                            <div class="flex items-center gap-2 p-3 border-b border-gray-100">
                                                <input type="text" id="pdfGoldFilmName_0" value="金膜"
                                                       class="input-field flex-1 px-3 py-2">
                                                <button type="button" onclick="addGoldFilmRow()" 
                                                        class="btn-secondary w-8 h-8 flex items-center justify-center rounded-lg hover:bg-primary-100" title="添加金膜">
                                                    <i class="fa fa-plus text-primary-600"></i>
                                                </button>
                                                <button type="button" onclick="removeGoldFilmRow(0)" 
                                                        class="bg-red-50 text-red-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-100" title="删除金膜">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- 金膜价格和金膜长度作为子框 -->
                                            <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">金膜价格 (元/卷)</label>
                                                    <input type="number" id="pdfGoldFilmPrice_0" step="0.01" min="0" value="0"
                                                           class="input-field w-full px-3 py-2" inputmode="decimal">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">金膜长度 (米)</label>
                                                    <input type="number" id="pdfGoldFilmLength_0" step="0.01" min="0" value="1200"
                                                           class="input-field w-full px-3 py-2" inputmode="decimal">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="calculateAllPdfPages()" id="calculateAllPagesBtn"
                                class="btn-primary mt-6 w-full py-3 px-6 text-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none hidden" 
                                disabled>
                            <i class="fa fa-calculator mr-2"></i> 一键定乾坤
                        </button>
                        
                        <!-- PDF计算进度条 -->
                        <div id="pdfCalculationProgress" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-30 backdrop-blur-sm">
                            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm transform transition-all scale-95 opacity-0" id="progressDialog">
                                <div class="flex flex-col items-center">
                                    <div class="w-20 h-20 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-6"></div>
                                    <h4 class="text-lg font-semibold text-gray-900 mb-2">正在计算中</h4>
                                    <p id="pdfProgressText" class="text-gray-600 text-sm mb-6">处理页面 0/0</p>
                                    <div class="w-full">
                                        <div class="h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                                            <div id="pdfProgressBar" class="h-full bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：PDF预览和结果区域 -->
                <div class="lg:col-span-2">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fa fa-eye text-primary-500 mr-2"></i>
                            PDF预览
                        </h3>
                        
                        <div id="pdfPreview" class="hidden">
                            <div class="relative mb-4">
                                <div id="pdfCanvasContainer" class="relative mx-auto">
                                    <canvas id="pdfCanvas" class="border border-gray-200 rounded-lg max-w-full h-auto"></canvas>
                                </div>
                                
                                <!-- PDF导航控制 -->
                                <div id="pdfNavigation" class="hidden absolute inset-0 flex items-center justify-between px-4">
                                    <button onclick="navigatePdfPage(-1)" id="prevPdfPageBtn" 
                                            class="bg-white/90 text-primary-700 w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-white transition-all transform hover:scale-105">
                                        <i class="fa fa-chevron-left text-lg"></i>
                                    </button>
                                    <button onclick="navigatePdfPage(1)" id="nextPdfPageBtn" 
                                            class="bg-white/90 text-primary-700 w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-white transition-all transform hover:scale-105">
                                        <i class="fa fa-chevron-right text-lg"></i>
                                    </button>
                                </div>
                                
                                <!-- PDF缩放控制 -->
                                <div id="pdfZoomControls" class="hidden absolute top-2 right-2 flex items-center space-x-3">
                                    <div class="text-sm text-gray-600 bg-white/90 px-3 py-1 rounded-full shadow">
                                        <i class="fa fa-mouse-pointer mr-1"></i>滚轮缩放
                                    </div>
                                    <button onclick="resetPdfZoom()" id="resetPdfZoomBtn" 
                                            class="bg-white/90 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center shadow hover:bg-white transition-all" title="重置视图">
                                        <i class="fa fa-refresh"></i>
                                    </button>
                                </div>
                                
                                <!-- PDF预览信息显示 - 移到底部并改为两排布局 -->
                                <div id="pdfPreviewInfo" class="hidden absolute bottom-0 left-0 right-0 bg-black/70 text-white p-3 text-sm">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="flex flex-col space-y-2">
                                            <div class="flex items-center space-x-3">
                                                <span class="font-medium min-w-[80px]">像素尺寸:</span>
                                                <span id="pdfPreviewPixelSize" class="text-white">-</span>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <span class="font-medium min-w-[80px]">实际尺寸:</span>
                                                <span id="pdfPreviewActualSize" class="text-white">-</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col space-y-2">
                                            <div class="flex items-center space-x-3">
                                                <span class="font-medium min-w-[80px]">总面积:</span>
                                                <span id="pdfPreviewTotalArea" class="text-white">-</span>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <span class="font-medium min-w-[80px]">油墨面积:</span>
                                                <span id="pdfPreviewInkArea" class="text-white">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 当前PDF页面参数 -->
                            <div id="pdfPageParameters" class="hidden bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="text-md font-medium text-gray-900 mb-3">当前页面参数</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">油墨价格 (元/kg)</label>
                                        <input type="number" id="pdfCurrentInkPrice" step="0.01" min="0.01" value="100"
                                               onchange="updateCurrentPdfPageParam('price', this.value)"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">覆盖面积 (m²/kg)</label>
                                        <input type="number" id="pdfCurrentInkCoverage" step="0.01" min="0.01" value="1"
                                               onchange="updateCurrentPdfPageParam('coverage', this.value)"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" inputmode="decimal">
                                    </div>
                                </div>
                            </div>
                            
                            
                            
                        </div>
                        
                        <div id="noPdfPreview" class="flex flex-col items-center justify-center py-12 min-h-[300px]">
                            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fa fa-file-pdf-o text-gray-300 text-4xl"></i>
                            </div>
                            <p class="text-gray-500">请上传PDF文件以查看预览</p>
                        </div>
                        
                        <!-- PDF详细计算参数 -->
                        <div id="pdfCalculationDetails" class="hidden mt-6 animate-fadeIn">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">详细计算参数</h3>
                                <!-- 页面选择器 -->
                                <div id="pdfPageSelector" class="hidden">
                                    <label class="text-sm text-gray-600 mr-2">选择页面：</label>
                                    <select id="pdfDetailPageSelector" onchange="switchDetailPage(this.value)"
                                            class="text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- 页面信息 -->
                                    <div>
                                        <h4 class="text-md font-medium text-gray-900 mb-3">页面信息</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">文件名称：</span>
                                                <span id="pdfDetailFileName" class="font-medium text-gray-900">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">页面名称：</span>
                                                <span id="pdfDetailPageName" class="font-medium text-gray-900">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">页码：</span>
                                                <span id="pdfDetailPageNumber" class="font-medium text-gray-900">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">像素尺寸：</span>
                                                <span id="pdfDetailPixelSize" class="font-medium text-gray-900">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">实际尺寸：</span>
                                                <span id="pdfDetailActualSize" class="font-medium text-gray-900">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 计算参数 -->
                                    <div>
                                        <h4 class="text-md font-medium text-gray-900 mb-3">计算参数</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">油墨价格：</span>
                                                <span id="pdfDetailInkPrice" class="font-medium text-gray-900">- 元/kg</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">覆盖面积：</span>
                                                <span id="pdfDetailInkCoverage" class="font-medium text-gray-900">- m²/kg</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">花纸排版数量：</span>
                                                <span id="pdfDetailLayoutCount" class="font-medium text-gray-900">- 个/版</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">订单数量：</span>
                                                <span id="pdfDetailOrderCount" class="font-medium text-gray-900">- 个</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">人工水电：</span>
                                                <span id="pdfDetailLaborCost" class="font-medium text-gray-900">- 元</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 计算进度条 -->
                            <div id="calculationProgressContainer" class="hidden mb-4">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-700">计算进度</span>
                                    <span id="calculationProgressText" class="text-sm font-medium text-gray-700">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="calculationProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- 油墨计算区域 -->
                            <div class="text-center mb-4">
                                <h4 class="text-lg font-bold text-gray-900">油墨计算区域</h4>
                            </div>
                            
                            <!-- 计算结果表格 -->
                            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">色序</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">页面尺寸</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总面积 (m²)</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">油墨面积 (m²)</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">覆盖率</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">油墨量 (g)</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成本 (元)</th>

                                            </tr>
                                        </thead>
                                        <tbody id="pdfCalculationTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- 表格内容将通过JavaScript动态生成 -->
                                        </tbody>
                                        <tfoot id="pdfCalculationTableFooter" class="bg-gray-50">
                                            <!-- 合计行将通过JavaScript动态生成 -->
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            
                            
                            
                        </div>
                        
                        <!-- 纸张用量和成本汇总 -->
                        <div id="pdfPaperSummary" class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6 hidden">
                            <div class="p-4">
                                <h4 class="text-md font-bold text-gray-900 mb-4 text-center">纸张金膜人工水电计算区域</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">总纸张用量：</span>
                                            <span id="pdfTotalPaperCount" class="text-xl font-bold text-gray-900">- 张</span>
                                        </div>
                                    </div>

                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">总纸张成本：</span>
                                            <span id="pdfTotalPaperCost" class="text-xl font-bold text-green-600">- 元</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 金膜信息区域 -->
                                <div id="pdfGoldFilmInfo" class="mt-6">
                                    <h5 class="text-base font-semibold text-gray-900 mb-3">金膜信息</h5>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="text-base text-gray-500">暂无金膜数据</div>
                                    </div>
                                </div>
                                
                                <!-- 人工水电信息区域 -->
                                <div id="pdfLaborInfo" class="mt-6">
                                    <h5 class="text-base font-semibold text-gray-900 mb-3">人工水电信息</h5>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">
                                            <div class="flex items-center">
                                                <span class="font-medium w-16">单价:</span>
                                                <span id="pdfLaborPrice" class="font-medium">- 元/张</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="font-medium w-16">数量:</span>
                                                <span id="pdfLaborCount" class="font-medium">- 张</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="font-medium w-16">成本:</span>
                                                <span id="pdfLaborTotalCost" class="font-bold text-purple-600">- 元</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PDF计算结果 -->
                        <div id="pdfResults" class="hidden mt-6 animate-fadeIn">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">计算结果</h3>
                            
                            <!-- 最终计算结果 -->
                            <div id="pdfFinalResult" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- 单张纸价格 -->
                                    <div>
                                        <div class="bg-blue-50 p-4 rounded-lg mb-3">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">单张纸价格</h4>
                                            <div class="flex items-end">
                                                <span id="pdfSinglePaperPrice" class="text-3xl font-bold text-blue-600">0.00</span>
                                                <span class="text-gray-600 ml-2">元/张</span>
                                            </div>
                                        </div>
                                        <!-- 单张纸成本（实际金膜用量） -->
                                        <div class="bg-purple-50 p-4 rounded-lg">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">单张纸成本（实际金膜用量）</h4>
                                            <div class="flex items-end">
                                                <span id="pdfSinglePaperPriceActual" class="text-3xl font-bold text-purple-600">0.00</span>
                                                <span class="text-gray-600 ml-2">元/张</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 单个花纸价格 -->
                                    <div>
                                        <div class="bg-green-50 p-4 rounded-lg mb-3">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">单个花纸价格</h4>
                                            <div class="flex items-end">
                                                <span id="pdfSingleLabelPrice" class="text-3xl font-bold text-green-600">0.00</span>
                                                <span class="text-gray-600 ml-2">元/个</span>
                                            </div>
                                        </div>
                                        <!-- 单个花纸价格（实际金膜用量） -->
                                        <div class="bg-purple-50 p-4 rounded-lg">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">单个花纸价格（实际金膜用量）</h4>
                                            <div class="flex items-end">
                                                <span id="pdfSingleLabelPriceActual" class="text-3xl font-bold text-purple-600">0.00</span>
                                                <span class="text-gray-600 ml-2">元/个</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 详细计算明细 -->
                                <div class="mt-6 border-t pt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">计算明细</h4>
                                    <div class="space-y-2 text-sm">

                                        
                                        <!-- 计算过程按钮 -->
                                        <div class="mb-4">
                                            <button type="button" onclick="toggleCalculationProcess()" 
                                                    class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                </svg>
                                                查看计算过程
                                            </button>
                                        </div>
                                        
                                        <!-- 动态计算过程悬浮层 -->
                                        <div id="calculationProcessModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                                            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                                <div class="flex justify-between items-center p-4 border-b">
                                                    <h3 class="text-lg font-semibold text-gray-900">计算过程详情</h3>
                                                    <button type="button" onclick="toggleCalculationProcess()" 
                                                            class="text-gray-400 hover:text-gray-600 focus:outline-none">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="p-6">
                                                    <div class="space-y-4 text-sm" id="pdfCalculationProcess">
                                                        <div class="text-gray-400 italic">暂无计算过程</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 实时计算结果 -->
                                        <div class="border-t pt-3">
                                            <div class="text-xs font-medium text-gray-700 mb-2">实时计算结果：</div>
                                            <div class="space-y-2">
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">油墨总成本：</span>
                                                    <span id="pdfTotalInkCost" class="font-medium">0.00 元</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">人工水电成本：</span>
                                                    <span id="pdfLaborCostDetail" class="font-medium">0.00 元</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">金膜成本：</span>
                                                    <span id="pdfGoldFilmCost" class="font-medium">0.00 元</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">金膜实际成本：</span>
                                                    <span id="pdfActualGoldFilmCost" class="font-medium text-green-600">0.00 元</span>
                                                </div>
                                                <div class="border-t pt-2 flex justify-between font-semibold">
                                                    <span>单张纸总成本：</span>
                                                    <span id="pdfTotalPaperCostDetail" class="text-blue-600">0.00 元</span>
                                                </div>
                                                <div class="border-t pt-2 flex justify-between font-semibold">
                                                    <span>单张纸成本（实际金膜用量）：</span>
                                                    <span id="pdfTotalPaperCostActualDetail" class="text-purple-600">0.00 元</span>
                                                </div>
                                                <div class="flex justify-between text-gray-600">
                                                    <span>花纸排版数量：</span>
                                                    <span id="pdfLayoutCount">0 个/版</span>
                                                </div>
                                                <div class="border-t pt-2 flex justify-between font-semibold">
                                                    <span>单个花纸价格（单张纸价格 ÷ 排版数量）：</span>
                                                    <span id="pdfSingleLabelPriceDetail" class="text-green-600">0.00 元</span>
                                                </div>
                                                <div class="border-t pt-2 flex justify-between font-semibold">
                                                    <span>单个花纸价格（实际金膜用量）：</span>
                                                    <span id="pdfSingleLabelPriceActualDetail" class="text-purple-600">0.00 元</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">使用帮助</h3>
                <button onclick="toggleHelpModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center py-8">
                <div class="bg-red-50 border border-red-100 rounded-lg p-6 mb-6">
                    <h4 class="font-semibold text-red-800 mb-4 text-lg">如需帮助，请联系作者</h4>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flex items-center space-x-3 text-gray-700">
                            <i class="fa fa-user text-red-500 text-xl"></i>
                            <span class="font-medium">王健超</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <i class="fa fa-phone text-red-500 text-xl"></i>
                            <span>18875045758</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <i class="fa fa-wechat text-red-500 text-xl"></i>
                            <span>微信同号</span>
                        </div>
                    </div>
                </div>
                
                <div class="text-gray-500 text-sm">
                    <p>感谢使用海翔花纸成本测算系统</p>
                    <p class="mt-1">我们将竭诚为您提供技术支持和服务</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let pdfDocument = null;
        let currentPdfPage = 1;
        let pdfZoom = 1.0;
        let pdfCalculationResults = [];
        let pdfPageParameters = {};
        
        // 图片相关全局变量
        let imageFiles = [];
        let batchFiles = [];
        let currentImageIndex = 0;
        let currentImageFile = null;
        let imageZoom = 1.0;
        let batchResults = [];
        let imageParameters = {};

        // 设置PDF.js worker路径
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('花纸测算系统初始化完成');
            
            // 添加拖拽支持
            initDragAndDrop();
        });

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // 移除所有标签按钮的激活状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-500');
                btn.classList.add('hover:text-gray-700');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + 'Content').classList.add('active');
            
            // 激活选中的标签按钮
            const activeBtn = document.getElementById(tabName + 'Tab');
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.remove('hover:text-gray-700');
        }

        // 切换帮助模态框
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('hidden');
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制', 'error');
            });
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(10)) + ' ' + sizes[i];
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform opacity-0 max-w-xs text-center`;
            
            // 根据类型设置颜色
            switch (type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-error', 'text-white');
                    break;
                case 'warning':
                    toast.classList.add('bg-warning', 'text-white');
                    break;
                default:
                    toast.classList.add('bg-gray-800', 'text-white');
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 10);
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 初始化拖拽支持
        function initDragAndDrop() {
            const dropAreas = document.querySelectorAll('.file-drop-area');
            
            dropAreas.forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('active');
                });
                
                area.addEventListener('dragleave', () => {
                    area.classList.remove('active');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('active');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const input = area.querySelector('input[type="file"]');
                        if (input) {
                            input.files = files;
                            input.onchange(input);
                        }
                    }
                });
            });
        }

        // 处理图片上传
        function handleImageUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            console.log('上传图片文件数量:', files.length);
            
            // 清除文件输入框的值，允许重新上传相同文件
            const inputElement = document.getElementById('imageUpload');
            if (inputElement) {
                inputElement.value = '';
            }
            
            // 验证文件类型
            const validFiles = files.filter(file => {
                const type = file.type;
                return type === 'image/jpeg' || type === 'image/png' || type === 'image/gif' || type === 'image/bmp';
            });
            
            if (validFiles.length === 0) {
                showToast('请上传有效的图片文件 (JPG, PNG, GIF, BMP)', 'error');
                return;
            }
            
            // 显示上传进度条
            const progressContainer = document.getElementById('imageUploadProgress');
            const progressBar = document.getElementById('imageUploadProgressBar');
            const progressText = document.getElementById('imageUploadProgressText');
            const progressPercent = document.getElementById('imageUploadProgressPercent');
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '处理中...';
            progressPercent.textContent = '0%';
            
            // 清空之前的文件
            imageFiles = [];
            batchFiles = [];
            currentImageIndex = 0;
            currentImageFile = null;
            imageParameters = {};
            
            // 处理文件
            let processed = 0;
            const total = validFiles.length;
            
            function processNext() {
                if (processed >= total) {
                    // 所有文件处理完成
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressText.textContent = '处理完成';
                    
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        updateImagePreview();
                        updateCalculateButtonState();
                    }, 500);
                    return;
                }
                
                const file = validFiles[processed];
                
                // 保存文件信息
                const fileInfo = {
                    originalFile: file,
                    displayName: file.name,
                    size: file.size,
                    type: file.type
                };
                
                imageFiles.push(fileInfo);
                batchFiles.push(file);
                
                // 初始化参数
                imageParameters[processed] = {
                    inkPrice: 100,
                    inkCoverage: 1
                };
                
                processed++;
                const percent = Math.round((processed / total) * 100);
                progressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
                progressText.textContent = `处理文件 ${processed}/${total}`;
                
                // 继续处理下一个文件
                setTimeout(processNext, 10);
            }
            
            processNext();
        }

        // 更新图片预览
        function updateImagePreview() {
            if (imageFiles.length === 0) return;
            
            // 显示预览区域
            document.getElementById('imagePreview').classList.remove('hidden');
            document.getElementById('batchPreview').classList.remove('hidden');
            document.getElementById('noImagePreview').classList.add('hidden');
            
            // 设置当前文件
            currentImageFile = imageFiles[0];
            currentImageIndex = 0;
            
            // 更新文件名显示
            updateImageFileNameDisplay();
            
            // 加载图片预览
            loadImagePreview(currentImageFile);
            
            // 更新导航按钮状态
            updateImageNavigationButtons();
            
            // 更新批量预览
            updateBatchPreview();
            
            // 更新文件列表
            updateImageFileList();
        }

        // 更新文件名显示
        function updateImageFileNameDisplay() {
            if (!currentImageFile) return;
            
            const displayElement = document.getElementById('imageFileNameDisplay');
            const editElement = document.getElementById('imageFileNameEdit');
            const inputElement = document.getElementById('imageFileNameInput');
            const sizeElement = document.getElementById('imageFileSize');
            
            displayElement.textContent = currentImageFile.displayName;
            inputElement.value = currentImageFile.displayName;
            sizeElement.textContent = formatFileSize(currentImageFile.size);
            
            displayElement.classList.remove('hidden');
            editElement.classList.add('hidden');
        }

        // 开始编辑文件名
        function startEditImageFileName() {
            if (!currentImageFile) return;
            
            const displayElement = document.getElementById('imageFileNameDisplay');
            const editElement = document.getElementById('imageFileNameEdit');
            const inputElement = document.getElementById('imageFileNameInput');
            
            displayElement.classList.add('hidden');
            editElement.classList.remove('hidden');
            inputElement.focus();
            inputElement.select();
        }

        // 保存文件名
        function saveImageFileName() {
            if (!currentImageFile) return;
            
            const inputElement = document.getElementById('imageFileNameInput');
            const newName = inputElement.value.trim();
            
            if (newName) {
                currentImageFile.displayName = newName;
                updateImageFileNameDisplay();
                showToast('文件名已更新', 'success');
            } else {
                updateImageFileNameDisplay();
            }
        }

        // 加载图片预览
        function loadImagePreview(fileInfo) {
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                img.src = e.target.result;
                
                img.onload = function() {
                    // 更新预览图片
                    const previewImg = document.getElementById('previewImage');
                    previewImg.src = img.src;
                    
                    // 更新图片信息
                    document.getElementById('pixelSize').textContent = `${img.width} × ${img.height}`;
                    
                    // 使用标准300 DPI计算实际尺寸
                    const dpi = 300;
                    const widthMm = (img.width / dpi) * 25.4;
                    const heightMm = (img.height / dpi) * 25.4;
                    document.getElementById('actualSize').textContent = `${parseFloat(widthMm.toFixed(10))} × ${parseFloat(heightMm.toFixed(10))} mm`;
                    
                    // 像素密度
                    const pixelDensity = dpi / 25.4; // 像素/毫米
                    document.getElementById('pixelDensity').textContent = `${parseFloat(pixelDensity.toFixed(10))} PPI`;
                    
                    // 显示图片详情
                    document.getElementById('imageDetails').classList.remove('hidden');
                    
                    // 添加缩放和拖拽功能
                    addImageZoomAndPan(previewImg);
                    
                    // 显示缩放控制
                    document.getElementById('imageZoomControls').classList.remove('hidden');
                    
                    // 显示索引
                    document.getElementById('imageIndexDisplay').textContent = `${currentImageIndex + 1}/${imageFiles.length}`;
                    document.getElementById('imageIndexDisplay').classList.remove('hidden');
                };
                
                img.onerror = function() {
                    showToast('图片加载失败: ' + fileInfo.displayName, 'error');
                };
            };
            
            reader.readAsDataURL(fileInfo.originalFile);
        }

        // 添加图片缩放和平移功能
        function addImageZoomAndPan(img) {
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;
            
            // 重置变换
            img.style.transform = 'scale(1) translate(0, 0)';
            imageZoom = 1.0;
            
            // 鼠标滚轮缩放
            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newZoom = Math.max(0.1, Math.min(3.0, imageZoom + delta));
                
                if (newZoom !== imageZoom) {
                    imageZoom = newZoom;
                    updateImageTransform(img, translateX, translateY);
                }
            });
            
            // 鼠标拖拽
            img.addEventListener('mousedown', (e) => {
                if (imageZoom > 1) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    img.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateImageTransform(img, translateX, translateY);
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                img.style.cursor = 'grab';
            });
        }

        // 更新图片变换
        function updateImageTransform(img, translateX, translateY) {
            img.style.transform = `scale(${imageZoom}) translate(${translateX / imageZoom}px, ${translateY / imageZoom}px)`;
        }

        // 重置图片缩放
        function resetZoom() {
            const img = document.getElementById('previewImage');
            if (img) {
                imageZoom = 1.0;
                img.style.transform = 'scale(1) translate(0, 0)';
            }
        }

        // 更新图片导航按钮状态
        function updateImageNavigationButtons() {
            const prevBtn = document.getElementById('prevImageBtn');
            const nextBtn = document.getElementById('nextImageBtn');
            const navigation = document.getElementById('imageNavigation');
            
            if (imageFiles.length <= 1) {
                navigation.classList.add('hidden');
                return;
            }
            
            navigation.classList.remove('hidden');
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === imageFiles.length - 1;
            
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }

        // 导航到上一张/下一张图片
        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            
            if (newIndex >= 0 && newIndex < imageFiles.length) {
                currentImageIndex = newIndex;
                currentImageFile = imageFiles[newIndex];
                updateImageFileNameDisplay();
                loadImagePreview(currentImageFile);
                updateImageNavigationButtons();
                
                // 如果有计算结果，显示当前图片的结果
                if (batchResults.length > 0) {
                    const currentResult = batchResults.find(r => r.index === currentImageIndex);
                    if (currentResult) {
                        updateSingleImageResults(currentResult);
                    }
                }
            }
        }

        // 更新批量预览
        function updateBatchPreview() {
            const grid = document.getElementById('batchPreviewGrid');
            grid.innerHTML = '';
            
            imageFiles.forEach((fileInfo, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'relative bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all';
                previewItem.onclick = () => {
                    currentImageIndex = index;
                    currentImageFile = fileInfo;
                    updateImageFileNameDisplay();
                    loadImagePreview(fileInfo);
                    updateImageNavigationButtons();
                };
                
                const img = document.createElement('img');
                img.className = 'w-full h-24 object-cover';
                img.alt = fileInfo.displayName;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(fileInfo.originalFile);
                
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all flex items-center justify-center';
                
                const indexSpan = document.createElement('span');
                indexSpan.className = 'text-white font-medium text-lg opacity-0 hover:opacity-100 transition-opacity';
                indexSpan.textContent = index + 1;
                
                overlay.appendChild(indexSpan);
                previewItem.appendChild(img);
                previewItem.appendChild(overlay);
                grid.appendChild(previewItem);
            });
            
            // 更新批量预览详情
            document.getElementById('batchFileCount').textContent = imageFiles.length;
            
            // 计算总像素面积
            let totalPixelArea = 0;
            imageFiles.forEach(fileInfo => {
                // 这里需要实际读取图片尺寸，暂时使用估算值
                totalPixelArea += 1000000; // 假设平均每张图片100万像素
            });
            document.getElementById('batchTotalPixelArea').textContent = parseFloat((totalPixelArea / 1000000).toFixed(10)) + ' MP';
            
            // 平均比例尺（使用标准300 DPI）
            const avgScale = 300 / 25.4; // 像素/毫米
            document.getElementById('batchAvgScale').textContent = parseFloat(avgScale.toFixed(10)) + ' PPI';
            
            // 预计处理时间（每张图片约1秒）
            const estimatedTime = Math.max(1, imageFiles.length);
            document.getElementById('batchEstimatedTime').textContent = estimatedTime + ' 秒';
        }

        // 更新图片文件列表
        function updateImageFileList() {
            const container = document.getElementById('imageFileItems');
            container.innerHTML = '';
            
            imageFiles.forEach((fileInfo, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200 hover:border-primary transition-colors';
                
                fileItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-primary/10 rounded flex items-center justify-center">
                            <i class="fa fa-image text-primary"></i>
                        </div>
                        <div class="min-w-0">
                            <div class="text-xs font-medium text-gray-900 truncate">${fileInfo.displayName}</div>
                            <div class="text-xs text-gray-500">${formatFileSize(fileInfo.size)}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="selectImageFile(${index})" 
                                class="text-primary hover:text-primary/80 transition-colors p-1 rounded" title="选择此文件">
                            <i class="fa fa-check-circle"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(fileItem);
            });
            
            document.getElementById('imageFileList').classList.remove('hidden');
        }

        // 选择图片文件
        function selectImageFile(index) {
            if (index >= 0 && index < imageFiles.length) {
                currentImageIndex = index;
                currentImageFile = imageFiles[index];
                updateImageFileNameDisplay();
                loadImagePreview(currentImageFile);
                updateImageNavigationButtons();
            }
        }

        // 更新计算按钮状态
        function updateCalculateButtonState() {
            const btn = document.getElementById('calculateBatchBtn');
            btn.disabled = imageFiles.length === 0;
        }

        // 计算批量图片
        function calculateBatch() {
            console.log('开始批量计算...');
            console.log('当前imageFiles长度:', imageFiles.length);
            console.log('当前batchFiles长度:', batchFiles.length);
            
            if (imageFiles.length === 0 || batchFiles.length === 0) {
                showToast('请先上传图片', 'error');
                return;
            }
            
            const totalFiles = imageFiles.length;
            let processedFiles = 0;
            batchResults = [];
            
            // 显示计算进度
            document.getElementById('batchCalculationInProgress').classList.remove('hidden');
            
            // 更新进度文本
            updateBatchProgress(processedFiles, totalFiles);
            
            // 使用简化的顺序处理，确保事件处理正常
            processFilesSequentially();
            
            function processFilesSequentially() {
                const files = [...batchFiles];
                
                function processNext(index) {
                    if (index >= files.length) {
                        // 所有文件处理完成
                        completeBatchProcessing();
                        return;
                    }
                    
                    const file = files[index];
                    
                    processBatchImage(file, index).then(result => {
                        batchResults.push(result);
                        processedFiles++;
                        
                        // 更新进度
                        updateBatchProgress(processedFiles, totalFiles);
                        
                        // 继续处理下一个文件
                        setTimeout(() => {
                            processNext(index + 1);
                        }, 10); // 小延迟避免UI阻塞
                    }).catch(error => {
                        console.error(`处理文件 ${index} 时发生错误:`, error);
                        processedFiles++;
                        updateBatchProgress(processedFiles, totalFiles);
                        
                        // 即使出错也要继续处理下一个文件
                        setTimeout(() => {
                            processNext(index + 1);
                        }, 10);
                    });
                }
                
                // 开始处理第一个文件
                processNext(0);
            }
            
            function completeBatchProcessing() {
                // 保存批量计算结果到全局变量
                window.batchResults = batchResults;
                
                // 按索引排序结果
                batchResults.sort((a, b) => a.index - b.index);
                
                displayBatchResults(batchResults);
                document.getElementById('batchCalculationInProgress').classList.add('hidden');
                
                if (batchResults.length === totalFiles) {
                    showToast(`批量计算完成！共处理 ${totalFiles} 个文件`, 'success');
                } else {
                    showToast(`批量计算完成，但有 ${totalFiles - batchResults.length} 个文件处理失败`, 'warning');
                }
                
                // 处理完批量计算后，确保当前显示的图片也更新结果
                if (currentImageFile && currentImageIndex >= 0) {
                    const currentResult = batchResults.find(r => r.index === currentImageIndex);
                    if (currentResult) {
                        console.log('更新当前图片的计算结果显示');
                        updateSingleImageResults(currentResult);
                        document.getElementById('imageResults').classList.remove('hidden');
                    }
                }
            }
        }

        // 处理单个批量图片
        function processBatchImage(file, index) {
            return new Promise((resolve, reject) => {
                try {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const img = new Image();
                            
                            img.onload = function() {
                                try {
                                    // 创建canvas用于像素分析
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    ctx.drawImage(img, 0, 0);
                                    
                                    // 获取像素数据
                                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                    const data = imageData.data;
                                    
                                    // 优化的油墨像素计算算法
                                    let blackPixelCount = 0;
                                    const blockSize = 32; // 分块处理
                                    
                                    // 使用位运算和分块处理优化性能
                                    for (let i = 0; i < data.length; i += 4 * blockSize) {
                                        for (let j = 0; j < blockSize && i + j * 4 < data.length; j++) {
                                            const offset = i + j * 4;
                                            const r = data[offset];
                                            const g = data[offset + 1];
                                            const b = data[offset + 2];
                                            
                                            // 优化的油墨判断（使用位运算）
                                            if ((r | g | b) < 128) {
                                                blackPixelCount++;
                                            }
                                        }
                                    }
                                    
                                    // 计算油墨覆盖率
                                    const totalPixels = canvas.width * canvas.height;
                                    const coverage = (blackPixelCount / totalPixels) * 100;
                                    
                                    // 获取比例尺（使用与单独计算相同的标准300 DPI）
                                    const standardDpi = 300;
                                    const scale = standardDpi / 25.4; // 像素/毫米
                                    
                                    // 计算实际尺寸（毫米）
                                    const widthMm = img.width / scale;
                                    const heightMm = img.height / scale;
                                    
                                    // 计算面积（平方米）
                                    const totalArea = (widthMm * heightMm) / 1000000;
                                    const inkArea = totalArea * (coverage / 100);
                                    
                                    // 获取当前图片的油墨参数
                                    let inkPrice = 100;
                                    let inkCoverage = 1;
                                    
                                    if (imageParameters[index]) {
                                        inkPrice = imageParameters[index].inkPrice || 100;
                                        inkCoverage = imageParameters[index].inkCoverage || 1;
                                    }
                                    
                                    if (inkPrice <= 0 || inkCoverage <= 0) {
                                        throw new Error('油墨参数必须大于0');
                                    }
                                    
                                    // 获取生产参数
                                    const layoutCount = parseInt(document.getElementById('imageLayoutCount').value) || 1;
                                    const orderCount = parseInt(document.getElementById('imageOrderCount').value) || 1;
                                    
                                    // 计算油墨使用量和成本
                                    const inkWeight = inkArea / inkCoverage;
                                    const unitCost = (inkWeight * inkPrice) / layoutCount; // 单个体的成本
                                    const inkCost = unitCost * orderCount; // 总订单成本
                                    
                                    const result = {
                                        index: index,
                                        fileName: file.name,
                                        displayName: imageFiles[index]?.displayName || file.name,
                                        pixelSize: `${img.width} × ${img.height}`,
                                        actualSize: `${parseFloat(widthMm.toFixed(10))} × ${parseFloat(heightMm.toFixed(10))} mm`,
                                        totalArea: totalArea,
                                        inkArea: inkArea,
                                        coverage: coverage,
                                        inkWeight: inkWeight,
                                        inkCost: inkCost,
                                        unitCost: unitCost,
                                        layoutCount: layoutCount,
                                        orderCount: orderCount
                                    };
                                    
                                    resolve(result);
                                } catch (error) {
                                    reject(error);
                                }
                            };
                            
                            img.onerror = function() {
                                reject(new Error('图片加载失败'));
                            };
                            
                            img.src = e.target.result;
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('文件读取失败'));
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 更新批量计算进度
        function updateBatchProgress(processed, total) {
            const progressText = document.getElementById('batchProgressText');
            const progressBar = document.getElementById('batchProgressBar');
            
            if (progressText) {
                progressText.textContent = `处理页面 ${processed}/${total}`;
            }
            
            if (progressBar && total > 0) {
                const percentage = Math.round((processed / total) * 100);
                progressBar.style.width = percentage + '%';
            }
        }

        // 更新PDF计算进度
        function updatePdfProgress(processed, total) {
            const progressText = document.getElementById('pdfProgressText');
            const progressBar = document.getElementById('pdfProgressBar');
            const calculationProgressText = document.getElementById('calculationProgressText');
            const calculationProgressBar = document.getElementById('calculationProgressBar');
            
            if (progressText) {
                progressText.textContent = `处理页面 ${processed}/${total}`;
            }
            
            if (total > 0) {
                const percentage = Math.round((processed / total) * 100);
                
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
                
                if (calculationProgressText) {
                    calculationProgressText.textContent = percentage + '%';
                }
                
                if (calculationProgressBar) {
                    calculationProgressBar.style.width = percentage + '%';
                }
            }
        }

        // 显示批量计算结果
        function displayBatchResults(results) {
            if (results.length === 0) {
                showToast('没有成功处理的文件', 'warning');
                return;
            }
            
            // 按索引排序
            results.sort((a, b) => a.index - b.index);
            
            // 清空表格
            const tableBody = document.getElementById('batchTableBody');
            tableBody.innerHTML = '';
            
            // 计算总计
            let totalArea = 0;
            let totalInkArea = 0;
            let totalInkWeight = 0;
            let totalInkCost = 0;
            
            // 填充表格
            results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="py-2 px-4 text-sm text-gray-900">${index + 1}</td>
                    <td class="py-2 px-4 text-sm text-gray-600 truncate max-w-xs" title="${result.displayName || result.fileName}">${result.displayName || result.fileName}</td>
                    <td class="py-2 px-4 text-sm text-gray-900">${result.pixelSize}</td>
                    <td class="py-2 px-4 text-sm text-gray-900">${result.actualSize}</td>
                    <td class="py-2 px-4 text-sm text-gray-900">${parseFloat(result.totalArea.toFixed(10))}</td>
                    <td class="py-2 px-4 text-sm text-gray-900">${parseFloat(result.inkArea.toFixed(10))}</td>
                    <td class="py-2 px-4 text-sm text-primary font-medium">${parseFloat(result.coverage.toFixed(10))}%</td>
                    <td class="py-2 px-4 text-sm text-gray-900">${parseFloat((result.inkWeight * 1000).toFixed(10))}</td>
                    <td class="py-2 px-4 text-sm text-success font-medium">${parseFloat(result.inkCost.toFixed(10))}</td>
                `;
                
                tableBody.appendChild(row);
                
                // 累加总计
                totalArea += result.totalArea;
                totalInkArea += result.inkArea;
                totalInkWeight += result.inkWeight * 1000;
                totalInkCost += result.inkCost;
            });
            
            // 更新总计行
            document.getElementById('batchTotalAreaSum').textContent = parseFloat(totalArea.toFixed(10));
            document.getElementById('batchTotalInkAreaSum').textContent = parseFloat(totalInkArea.toFixed(10));
            document.getElementById('batchTotalCoverageAvg').textContent = totalArea > 0 ? parseFloat(((totalInkArea / totalArea) * 100).toFixed(10)) + '%' : '0%';
            document.getElementById('batchTotalInkWeightSum').textContent = parseFloat(totalInkWeight.toFixed(10));
            document.getElementById('batchTotalCostSum').textContent = parseFloat(totalInkCost.toFixed(10));
            
            // 显示结果
            document.getElementById('imageResults').classList.remove('hidden');
            document.getElementById('batchResults').classList.remove('hidden');
            
            // 自动显示当前选中页面的结果
            const currentPageResult = results.find(result => result.index === currentImageIndex);
            if (currentPageResult) {
                console.log('自动显示当前页面结果:', currentPageResult);
                updateSingleImageResults(currentPageResult);
            } else {
                console.log('未找到当前页面的计算结果');
            }
        }

        // 更新单张图片结果显示
        function updateSingleImageResults(result) {
            if (!result) {
                console.error('updateSingleImageResults: result is null or undefined');
                return;
            }
            
            console.log('更新单张图片结果:', result);
            
            // 更新所有结果显示元素
            document.getElementById('totalAreaResult').textContent = parseFloat(result.totalArea.toFixed(10)) + ' m²';
            document.getElementById('inkAreaResult').textContent = parseFloat(result.inkArea.toFixed(10)) + ' m²';
            document.getElementById('inkCoverageResult').textContent = parseFloat(result.coverage.toFixed(10)) + '%';
            document.getElementById('inkWeightResult').textContent = parseFloat((result.inkWeight * 1000).toFixed(10)) + ' g';
            document.getElementById('inkCostResult').textContent = result.inkCost.toFixed(2) + ' 元';
            document.getElementById('inkArea').textContent = result.inkArea.toFixed(2) + ' m²';
            
            // 更新新增的成本相关显示
            if (result.unitCost !== undefined) {
                document.getElementById('unitCostResult').textContent = result.unitCost.toFixed(2) + ' 元';
            }
            if (result.layoutCount !== undefined) {
                document.getElementById('layoutCountResult').textContent = result.layoutCount + ' 个/版';
            }
            if (result.orderCount !== undefined) {
                document.getElementById('orderCountResult').textContent = result.orderCount + ' 个';
            }
        }

        // 下载结果
        function downloadResult() {
            if (!currentImageFile || batchResults.length === 0) {
                showToast('没有可下载的结果', 'warning');
                return;
            }
            
            const currentResult = batchResults.find(r => r.index === currentImageIndex);
            if (!currentResult) {
                showToast('未找到当前图片的计算结果', 'warning');
                return;
            }
            
            const resultText = `酒标花纸成本测算结果
====================================
文件名称: ${currentResult.displayName || currentResult.fileName}
像素尺寸: ${currentResult.pixelSize}
实际尺寸: ${currentResult.actualSize}

面积信息:
- 总印刷面积: ${currentResult.totalArea.toFixed(2)} m²
- 油墨区域面积: ${currentResult.inkArea.toFixed(2)} m²
- 油墨覆盖率: ${currentResult.coverage.toFixed(2)}%

成本信息:
- 油墨使用量: ${(currentResult.inkWeight * 1000).toFixed(2)} g
- 单个体成本: ${currentResult.unitCost.toFixed(2)} 元
- 总订单成本: ${currentResult.inkCost.toFixed(2)} 元
- 排版数量: ${currentResult.layoutCount} 个/版
- 订单数量: ${currentResult.orderCount} 个

计算时间: ${new Date().toLocaleString('zh-CN')}
====================================`;
            
            downloadTextFile('成本测算结果.txt', resultText);
        }

        // 下载批量计算结果
        function downloadBatchResult() {
            if (batchResults.length === 0) {
                showToast('没有可下载的批量计算结果', 'warning');
                return;
            }
            
            let resultText = `酒标花纸批量成本测算结果
====================================
总文件数: ${batchResults.length}
计算时间: ${new Date().toLocaleString('zh-CN')}

详细结果:
====================================
序号,文件名,像素尺寸,实际尺寸,总面积(m²),油墨面积(m²),覆盖率(%),油墨量(kg),单个体成本(元),总订单成本(元),排版数量,订单数量`;
            
            // 获取表格数据
            batchResults.forEach((result, index) => {
                resultText += `\n${index + 1},${result.displayName || result.fileName},${result.pixelSize},${result.actualSize},${result.totalArea.toFixed(2)},${result.inkArea.toFixed(2)},${result.coverage.toFixed(2)},${(result.inkWeight * 1000).toFixed(2)},${result.unitCost.toFixed(2)},${result.inkCost.toFixed(2)},${result.layoutCount},${result.orderCount}`;
            });
            
            // 计算总计
            const totalArea = batchResults.reduce((sum, r) => sum + r.totalArea, 0);
            const totalInkArea = batchResults.reduce((sum, r) => sum + r.inkArea, 0);
            const totalInkWeight = batchResults.reduce((sum, r) => sum + r.inkWeight, 0);
            const totalInkCost = batchResults.reduce((sum, r) => sum + r.inkCost, 0);
            const avgCoverage = totalArea > 0 ? (totalInkArea / totalArea) * 100 : 0;
            
            resultText += `

总计:
====================================
- 总印刷面积: ${totalArea.toFixed(2)} m²
- 总油墨面积: ${totalInkArea.toFixed(2)} m²
- 平均覆盖率: ${avgCoverage.toFixed(2)}%
- 总油墨量: ${totalInkWeight.toFixed(2)} kg
- 总成本: ${totalInkCost.toFixed(2)} 元`;
            
            downloadTextFile('批量成本测算结果.csv', resultText);
        }

        // 下载文本文件
        function downloadTextFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 打印图片计算结果
        function printImageResult() {
            if (batchResults.length === 0) {
                showToast('没有可打印的结果', 'warning');
                return;
            }
            
            const currentResult = batchResults.find(r => r.index === currentImageIndex);
            if (!currentResult) {
                showToast('未找到当前图片的计算结果', 'warning');
                return;
            }
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h1 style="color: #1e40af; text-align: center; margin-bottom: 20px;">酒标花纸成本测算结果</h1>
                    
                    <div style="background-color: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h2 style="color: #1e40af; margin-top: 0;">基本信息</h2>
                        <p><strong>文件名称:</strong> ${currentResult.displayName || currentResult.fileName}</p>
                        <p><strong>像素尺寸:</strong> ${currentResult.pixelSize}</p>
                        <p><strong>实际尺寸:</strong> ${currentResult.actualSize}</p>
                        <p><strong>计算时间:</strong> ${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                            <h2 style="color: #1e40af; margin-top: 0;">面积信息</h2>
                            <p><strong>总印刷面积:</strong> ${currentResult.totalArea.toFixed(2)} m²</p>
                            <p><strong>油墨区域面积:</strong> ${currentResult.inkArea.toFixed(2)} m²</p>
                            <p><strong>油墨覆盖率:</strong> ${currentResult.coverage.toFixed(2)}%</p>
                        </div>
                        
                        <div style="flex: 1; background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                            <h2 style="color: #1e40af; margin-top: 0;">成本信息</h2>
                            <p><strong>油墨使用量:</strong> ${(currentResult.inkWeight * 1000).toFixed(2)} g</p>
                            <p><strong>单个体成本:</strong> ${currentResult.unitCost.toFixed(2)} 元</p>
                            <p><strong>总订单成本:</strong> ${currentResult.inkCost.toFixed(2)} 元</p>
                            <p><strong>排版数量:</strong> ${currentResult.layoutCount} 个/版</p>
                            <p><strong>订单数量:</strong> ${currentResult.orderCount} 个</p>
                        </div>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // 清空结果
        function clearResults() {
            batchResults = [];
            document.getElementById('imageResults').classList.add('hidden');
            document.getElementById('batchResults').classList.add('hidden');
            showToast('结果已清空', 'success');
        }

        // 处理PDF上传
        function handlePdfUpload(input) {
            console.log('开始处理PDF上传...');
            
            try {
                const file = input.files[0];
                if (!file) {
                    console.log('未选择PDF文件');
                    return;
                }
                
                // 重置所有PDF相关的全局变量和状态
                console.log('重置PDF相关状态...');
                pdfDocument = null;
                currentPdfPage = 1;
                pdfZoom = 1.0;
                pdfCalculationResults = [];
                pdfPageParameters = {};
                window.currentPdfFile = null;
                
                // 重置UI状态（添加错误处理）
                const resetElementVisibility = (elementId, action, className) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.classList[action](className);
                    } else {
                        console.warn(`元素 ${elementId} 不存在，跳过状态重置`);
                    }
                };
                
                resetElementVisibility('pdfPreview', 'add', 'hidden');
                resetElementVisibility('pdfInfo', 'add', 'hidden');
                resetElementVisibility('pdfDetails', 'add', 'hidden');
                resetElementVisibility('pdfResults', 'add', 'hidden');
                resetElementVisibility('noPdfPreview', 'remove', 'hidden');
                resetElementVisibility('pdfNavigation', 'add', 'hidden');
                resetElementVisibility('pdfZoomControls', 'add', 'hidden');
                resetElementVisibility('pdfCurrentPageTitle', 'add', 'hidden');
                resetElementVisibility('pdfBatchResults', 'add', 'hidden');
                resetElementVisibility('pdfSummary', 'add', 'hidden');
                resetElementVisibility('pdfCalculationDetails', 'add', 'hidden');
                resetElementVisibility('pdfPaperSummary', 'add', 'hidden');
                resetElementVisibility('pdfPageSelector', 'add', 'hidden');
                
                // 清空页面列表
                document.getElementById('pdfPageList').innerHTML = '';
                document.getElementById('pdfPageCount').textContent = '0';
                document.getElementById('pdfTotalPages').textContent = '0';
                document.getElementById('pdfCurrentPage').textContent = '1';
                
                // 禁用计算按钮
                document.getElementById('calculateAllPagesBtn').disabled = true;
                
                // 清除文件输入框的值，允许重新上传相同文件
                const inputElement = document.getElementById('pdfUpload');
                if (inputElement) {
                    inputElement.value = '';
                }
                
                if (file.type !== 'application/pdf') {
                    alert('请上传PDF格式的文件');
                    return;
                }
                
                console.log('PDF文件信息:', file.name, formatFileSize(file.size));
                
                // 显示上传进度条
                const progressContainer = document.getElementById('pdfUploadProgress');
                const progressBar = document.getElementById('pdfUploadProgressBar');
                const progressText = document.getElementById('pdfUploadProgressText');
                const progressPercent = document.getElementById('pdfUploadProgressPercent');
                
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '准备上传...';
                progressPercent.textContent = '0%';
                
                // 保存当前PDF文件到全局变量
                window.currentPdfFile = {
                    originalFile: file,
                    displayName: file.name,
                    size: file.size
                };
                
                // 显示文件信息
                document.getElementById('pdfFileNameDisplay').textContent = window.currentPdfFile.displayName;
                document.getElementById('pdfFileSize').textContent = formatFileSize(file.size);
                
                // 加载PDF文件
                const fileReader = new FileReader();
                
                // 添加进度监听
                fileReader.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const progress = (event.loaded / event.total) * 100;
                        const percent = Math.round(progress);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = '读取文件中...';
                        progressPercent.textContent = `${percent}%`;
                    }
                };
                
                fileReader.onload = function() {
                    try {
                        // 更新进度到90%，表示文件读取完成
                        progressBar.style.width = '90%';
                        progressText.textContent = '加载PDF中...';
                        progressPercent.textContent = '90%';
                        
                        const typedArray = new Uint8Array(this.result);
                        
                        // 使用PDF.js加载PDF
                        pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                            try {
                                // 更新进度到100%，表示PDF加载完成
                                progressBar.style.width = '100%';
                                progressText.textContent = '加载完成';
                                progressPercent.textContent = '100%';
                                pdfDocument = pdf;
                                currentPdfPage = 1;
                                pdfZoom = 1.0;
                                pdfCalculationResults = [];
                                pdfPageParameters = {};
                                
                                // 初始化每页的参数
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    pdfPageParameters[i] = {
                                        price: 100,
                                        coverage: 30,
                                        pageName: `第 ${i} 页`
                                    };
                                }
                                
                                // 更新PDF信息
                                document.getElementById('pdfTotalPages').textContent = pdf.numPages;
                                document.getElementById('pdfCurrentPage').textContent = currentPdfPage;
                                document.getElementById('pdfDetails').classList.remove('hidden');
                                
                                // 生成页面列表
                                generatePdfPageList();
                                
                                // 渲染第一页
                                renderPdfPage(currentPdfPage);
                                
                                console.log('PDF加载成功，共', pdf.numPages, '页');
                                
                                // 显示PDF信息、计算参数区域和"一键定乾坤"按钮
                                document.getElementById('pdfInfo').classList.remove('hidden');
                                document.getElementById('pdfInfoSection').classList.remove('hidden');
                                document.getElementById('calculationParameters').classList.remove('hidden');
                                document.getElementById('calculateAllPagesBtn').classList.remove('hidden');
                                document.getElementById('calculateAllPagesBtn').disabled = false;
                                
                                // 延迟隐藏进度条
                                setTimeout(() => {
                                    progressContainer.classList.add('hidden');
                                }, 500);
                                
                            } catch (error) {
                                console.error('处理PDF时发生错误:', error);
                                showToast('PDF处理失败：' + error.message, 'error');
                                progressContainer.classList.add('hidden');
                            }
                        }).catch(function(error) {
                            console.error('PDF加载失败:', error);
                            showToast('PDF加载失败：' + error.message, 'error');
                            progressContainer.classList.add('hidden');
                        });
                        
                    } catch (error) {
                        console.error('PDF文件处理过程中发生错误:', error);
                        showToast('PDF文件处理失败：' + error.message, 'error');
                        progressContainer.classList.add('hidden');
                    }
                };
                
                fileReader.onerror = function() {
                    console.error('PDF文件读取失败');
                    showToast('PDF文件读取失败，请重试', 'error');
                    progressContainer.classList.add('hidden');
                };
                
                fileReader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('PDF上传处理过程中发生错误:', error);
                showToast('PDF文件上传失败：' + error.message, 'error');
            }
        }

        // 生成PDF页面列表
        // 从PDF页面提取文本并识别色序
        async function extractColorSequenceFromPage(pageNumber) {
            try {
                console.log(`=== 开始提取页面${pageNumber}文本 ===`);
                
                const page = await pdfDocument.getPage(pageNumber);
                const content = await page.getTextContent();
                const textItems = content.items.map(item => item.str);
                const fullText = textItems.join(' ');
                
                console.log('提取到的文本:', fullText);
                
                // 尝试多种匹配模式以提高识别率
                const patterns = [
                    // 标准格式：色序：CMYK或汉字
                    /色序[：:]\s*([^，,。.；;\s]+)/,
                    // 宽松格式：色序： CMYK 或色序: CMYK，支持汉字
                    /色序[：:]\s*([\u4e00-\u9fa5A-Za-z0-9\s]+?)(?:[，,。.；;\s]|$)/,
                    // 更宽松格式：允许更多分隔符，支持汉字
                    /色序[：:]\s*([\u4e00-\u9fa5A-Za-z0-9\s]+?)(?:[，,。.；;\s]|$)/i,
                    // 尝试匹配行内的色序信息，支持汉字
                    /[色][序][：:]\s*([\u4e00-\u9fa5A-Za-z0-9\s]+?)(?:[，,。.；;\s]|$)/,
                    // 尝试匹配可能有空格的情况，支持汉字
                    /色序[：:]\s*([\u4e00-\u9fa5A-Za-z0-9]+(?:\s*[\u4e00-\u9fa5A-Za-z0-9]+)*)/
                ];
                
                let colorSequence = null;
                
                for (let i = 0; i < patterns.length; i++) {
                    const match = fullText.match(patterns[i]);
                    console.log(`匹配模式 ${i+1} 结果:`, match);
                    
                    if (match && match[1]) {
                        colorSequence = match[1].trim();
                        // 清理可能的特殊字符，但保留汉字
                        colorSequence = colorSequence.replace(/[^\u4e00-\u9fa5A-Za-z0-9\s]/g, '');
                        console.log(`成功识别到色序 (模式${i+1}):`, colorSequence);
                        break;
                    }
                }
                
                // 如果正则匹配失败，尝试关键词搜索
                if (!colorSequence) {
                    const lines = fullText.split(/[\n\r]/);
                    for (let line of lines) {
                        line = line.trim();
                        if (line.includes('色序') || line.includes('色序：') || line.includes('色序:')) {
                            console.log('找到包含色序的行:', line);
                            // 尝试从行中提取色序信息
                            const parts = line.split(/[：:]/);
                            if (parts.length > 1) {
                                colorSequence = parts[1].trim().replace(/[^\u4e00-\u9fa5A-Za-z0-9\s]/g, '');
                                console.log('从行中提取的色序:', colorSequence);
                                if (colorSequence) break;
                            }
                        }
                    }
                }
                
                if (colorSequence) {
                    console.log(`页面${pageNumber}色序识别成功:`, colorSequence);
                    return colorSequence;
                }
                
                console.log(`页面${pageNumber}未找到"色序："相关信息`);
                return null;
            } catch (error) {
                console.error(`提取页面${pageNumber}文本时出错:`, error);
                return null;
            }
        }

        function generatePdfPageList() {
            const pageList = document.getElementById('pdfPageList');
            pageList.innerHTML = '';
            
            // 为每个页面提取色序信息
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                (async () => {
                    try {
                        // 提取色序信息
                        const colorSequence = await extractColorSequenceFromPage(i);
                        
                        // 获取或初始化文件参数
                        if (!pdfPageParameters[i]) {
                            pdfPageParameters[i] = {
                                price: 100,
                                coverage: 30,
                                pageName: colorSequence || '未识别成功'
                            };
                        } else if (colorSequence) {
                            // 如果识别到色序，则更新页面名称
                            pdfPageParameters[i].pageName = colorSequence;
                        } else if (!pdfPageParameters[i].pageName || pdfPageParameters[i].pageName.includes('第') && pdfPageParameters[i].pageName.includes('页')) {
                            // 如果未识别到色序且当前页面名称是默认的"第X页"格式，则更新为"未识别成功"
                            pdfPageParameters[i].pageName = '未识别成功';
                        }
                        
                        // 更新UI显示
                        const displayElement = document.getElementById(`pdfPageNameDisplay_${i}`);
                        const inputElement = document.getElementById(`pdfPageNameInput_${i}`);
                        
                        if (displayElement) {
                            displayElement.textContent = pdfPageParameters[i].pageName;
                        }
                        
                        if (inputElement) {
                            inputElement.value = pdfPageParameters[i].pageName;
                        }
                        
                    } catch (error) {
                        console.error(`处理页面${i}色序识别时出错:`, error);
                    }
                })();
            }
            
            // 生成页面列表UI
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const params = pdfPageParameters[i] || {
                    price: 100,
                    coverage: 30,
                    pageName: `第 ${i} 页`
                };
                const pageItem = document.createElement('div');
                pageItem.className = 'bg-white rounded-lg shadow-sm border border-gray-200 mb-3 cursor-pointer hover:shadow-md transition-shadow';
                pageItem.setAttribute('data-page', i);
                const pageNum = i;
                pageItem.onclick = () => viewPdfPage(pageNum);
                pageItem.innerHTML = `
                    <div class="flex items-center justify-between p-3 border-b border-gray-200">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="w-8 h-8 bg-primary/10 rounded flex items-center justify-center mr-3">
                                <i class="fa fa-file-pdf-o text-primary"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div id="pdfPageNameDisplay_${i}" class="text-sm font-medium truncate cursor-pointer hover:text-primary" onclick="event.stopPropagation(); startEditPdfPageName(${i})">
                                    <span class="${pdfPageParameters[i]?.pageName !== '未识别成功' ? 'text-gray-900' : 'text-gray-400 italic'}">
                                        ${pdfPageParameters[i]?.pageName === '未识别成功' ? '未识别成功请手动填写' : (pdfPageParameters[i]?.pageName || `第 ${i} 页`)}
                                    </span>
                                </div>
                                <div id="pdfPageNameEdit_${i}" class="hidden">
                                    <input type="text" id="pdfPageNameInput_${i}" value="${pdfPageParameters[i]?.pageName === '未识别成功' ? '' : (pdfPageParameters[i]?.pageName || `第 ${i} 页`)}" 
                                           placeholder="请输入页面名称"
                                           class="w-full text-xs border border-blue-300 rounded px-1 py-0.5 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           onkeydown="if(event.key === 'Enter') { event.stopPropagation(); savePdfPageName(${i}); }"
                                           onblur="savePdfPageName(${i});">
                                </div>
                                <p class="text-xs text-gray-500">PDF页面</p>
                            </div>
                            
                            
                            
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); startEditPdfPageName(${i})" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded"
                                    title="编辑页面名称">
                                <i class="fa fa-pencil text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div id="pdf_params_${i}" class="bg-gray-50 p-2 border-t border-gray-200" onclick="event.stopPropagation()">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">油墨价格 (元/kg)</label>
                                <input type="number" id="pdf_inkPrice_${i}" step="0.01" min="0.01" value="${params.price}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'price', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">覆盖面积 (m²/kg)</label>
                                <input type="number" id="pdf_inkCoverage_${i}" step="0.01" min="0.01" value="${params.coverage}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'coverage', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                            
                            
                            
                        </div>
                    </div>
                `;
                pageList.appendChild(pageItem);
            }
            
            document.getElementById('pdfPageCount').textContent = pdfDocument.numPages;
            updatePdfPageListSelection();
            
            // 启用计算按钮
            document.getElementById('calculateAllPagesBtn').disabled = false;
            
            // 页面列表生成后，检测当前页面名称并重新排序
            setTimeout(() => {
                console.log('延迟执行页面排序...');
                sortPdfPageListByName();
            }, 1000);
        }

        // 更新PDF页面列表选中状态
        function updatePdfPageListSelection() {
            const pageItems = document.querySelectorAll('#pdfPageList > div');
            pageItems.forEach((item) => {
                const pageNumber = parseInt(item.getAttribute('data-page'));
                if (pageNumber === currentPdfPage) {
                    item.classList.add('bg-primary/10', 'border-primary');
                    item.classList.remove('bg-white', 'border-gray-200');
                } else {
                    item.classList.remove('bg-primary/10', 'border-primary');
                    item.classList.add('bg-white', 'border-gray-200');
                }
            });
        }

        // 查看PDF页面
        function viewPdfPage(pageNumber) {
            if (pageNumber >= 1 && pageNumber <= pdfDocument.numPages) {
                currentPdfPage = pageNumber;
                document.getElementById('pdfCurrentPage').textContent = currentPdfPage;
                renderPdfPage(currentPdfPage);
                updatePdfPageListSelection();
                updatePdfNavigationButtons();
                
                // 更新当前页面参数显示
                updateCurrentPdfPageParameters();
                
                // 显示当前页面的计算结果
                const currentResult = pdfCalculationResults.find(r => r.pageNumber === currentPdfPage);
                if (currentResult) {
                    displayPdfResult(currentResult);
                }
            }
        }

        // 渲染PDF页面
        function renderPdfPage(pageNumber) {
            if (!pdfDocument) return;
            
            pdfDocument.getPage(pageNumber).then(function(page) {
                const canvas = document.getElementById('pdfCanvas');
                const container = document.getElementById('pdfCanvasContainer');
                
                // 设置缩放比例
                const viewport = page.getViewport({ scale: pdfZoom });
                
                // 设置canvas尺寸
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // 渲染PDF页面
                const renderContext = {
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(function() {
                    // 显示预览区域
                    document.getElementById('pdfPreview').classList.remove('hidden');
                    document.getElementById('noPdfPreview').classList.add('hidden');
                    
                    // 显示导航控制
                    document.getElementById('pdfNavigation').classList.remove('hidden');
                    document.getElementById('pdfZoomControls').classList.remove('hidden');
                    
                    // 更新页面尺寸显示 - 使用与计算结果相同的计算方式
                    const dpi = 72; // PDF标准DPI
                    const widthMm = (canvas.width / dpi) * 25.4;
                    const heightMm = (canvas.height / dpi) * 25.4;
                    document.getElementById('pdfPageSize').textContent = `${widthMm.toFixed(1)} × ${heightMm.toFixed(1)} mm`;
                    
                    // 更新预览信息显示 - 恢复为之前版本的样式和内容
                    const pixelSize = `${Math.round(canvas.width)} × ${Math.round(canvas.height)}`;
                    const actualSize = `${widthMm.toFixed(2)} × ${heightMm.toFixed(2)} mm`;
                    
                    document.getElementById('pdfPreviewPixelSize').textContent = pixelSize;
                    document.getElementById('pdfPreviewActualSize').textContent = actualSize;
                    
                    // 查找当前页面的计算结果
                    const currentResult = pdfCalculationResults.find(r => r.pageNumber === pageNumber);
                    if (currentResult) {
                        document.getElementById('pdfPreviewTotalArea').textContent = `${currentResult.totalArea.toFixed(2)} m²`;
                        document.getElementById('pdfPreviewInkArea').textContent = `${currentResult.inkArea.toFixed(2)} m²`;
                    } else {
                        document.getElementById('pdfPreviewTotalArea').textContent = '-';
                        document.getElementById('pdfPreviewInkArea').textContent = '-';
                    }
                    
                    // 显示预览信息
                    document.getElementById('pdfPreviewInfo').classList.remove('hidden');
                    
                    // 添加缩放和拖拽功能
                    addPdfZoomAndPan(canvas);
                });
            });
        }

        // 添加PDF缩放和平移功能
        function addPdfZoomAndPan(canvas) {
            // 重置变换
            canvas.style.transform = 'translate(0, 0)';
            canvas.style.cursor = 'grab';
            
            // 设置canvas的基本样式
            canvas.style.display = 'block';
            canvas.style.margin = '0 auto';
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            canvas.style.transformOrigin = 'center center';
            canvas.tabIndex = 0;
            
            // 存储当前的变换状态
            let currentScale = pdfZoom || 1;
            let currentTranslateX = 0;
            let currentTranslateY = 0;
            
            // 鼠标拖拽功能
            let isDragging = false;
            let startX, startY;
            let startTranslateX, startTranslateY;
            
            // 为canvas添加滚轮事件监听器
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Canvas wheel event triggered, deltaY:', e.deltaY);
                
                // 计算新的缩放比例
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(0.1, Math.min(3.0, currentScale + delta));
                
                if (newScale !== currentScale) {
                    currentScale = newScale;
                    pdfZoom = newScale; // 同步更新全局缩放变量
                    
                    console.log('New scale:', currentScale);
                    
                    // 应用变换
                    canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
                }
            }, { passive: false });
            
            // 为容器添加滚轮事件监听器作为备份
            const container = canvas.parentElement;
            if (container) {
                container.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Container wheel event triggered');
                    
                    // 计算新的缩放比例
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    const newScale = Math.max(0.1, Math.min(3.0, currentScale + delta));
                    
                    if (newScale !== currentScale) {
                        currentScale = newScale;
                        pdfZoom = newScale; // 同步更新全局缩放变量
                        
                        console.log('New scale from container:', currentScale);
                        
                        // 应用变换
                        canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
                    }
                }, { passive: false });
            }
            
            // 鼠标按下事件
            canvas.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startTranslateX = currentTranslateX;
                startTranslateY = currentTranslateY;
                canvas.style.cursor = 'grabbing';
            }, { passive: false });
            
            // 鼠标移动事件
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                currentTranslateX = startTranslateX + deltaX;
                currentTranslateY = startTranslateY + deltaY;
                
                // 应用变换
                canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
            });
            
            // 鼠标释放事件
            document.addEventListener('mouseup', function() {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });
            
            // 触摸设备支持
            canvas.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    isDragging = true;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    startTranslateX = currentTranslateX;
                    startTranslateY = currentTranslateY;
                }
            }, { passive: false });
            
            document.addEventListener('touchmove', function(e) {
                if (!isDragging || e.touches.length !== 1) return;
                
                e.preventDefault();
                const touch = e.touches[0];
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;
                
                currentTranslateX = startTranslateX + deltaX;
                currentTranslateY = startTranslateY + deltaY;
                
                // 应用变换
                canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
            }, { passive: false });
            
            document.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            // 初始应用变换
            canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
        }

        // 重置PDF缩放
        function resetPdfZoom() {
            pdfZoom = 1.0;
            // 重新渲染页面以重置所有变换
            renderPdfPage(currentPdfPage);
        }

        // 更新PDF导航按钮状态
        function updatePdfNavigationButtons() {
            if (!pdfDocument) return;
            
            const prevBtn = document.getElementById('prevPdfPageBtn');
            const nextBtn = document.getElementById('nextPdfPageBtn');
            
            prevBtn.disabled = currentPdfPage === 1;
            nextBtn.disabled = currentPdfPage === pdfDocument.numPages;
            
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }

        // 导航到上一页/下一页PDF
        function navigatePdfPage(direction) {
            if (!pdfDocument) return;
            
            const newPage = currentPdfPage + direction;
            if (newPage >= 1 && newPage <= pdfDocument.numPages) {
                viewPdfPage(newPage);
            }
        }

        // 更新当前PDF页面参数
        function updateCurrentPdfPageParam(paramName, value) {
            if (!pdfPageParameters[currentPdfPage]) {
                pdfPageParameters[currentPdfPage] = {
                    price: 100,
                    coverage: 1,
                    pageName: `第 ${currentPdfPage} 页`
                };
            }
            
            const numValue = parseFloat(value) || 0;
            if (numValue <= 0) {
                showToast('参数值必须大于0', 'warning');
                return;
            }
            
            pdfPageParameters[currentPdfPage][paramName] = numValue;
            console.log(`更新PDF页面 ${currentPdfPage} 的参数 ${paramName}:`, pdfPageParameters[currentPdfPage][paramName]);
            
            // 更新页面列表中的参数显示
            const inputElement = document.getElementById(`pdf_${paramName === 'price' ? 'inkPrice' : 'inkCoverage'}_${currentPdfPage}`);
            if (inputElement) {
                inputElement.value = numValue;
            }
            
            // 参数已保存，等待用户手动计算
            showToast('参数已保存', 'success');
        }

        // 更新PDF页面参数
        function updatePdfPageParam(pageNumber, paramName, value) {
            if (!pdfPageParameters[pageNumber]) {
                pdfPageParameters[pageNumber] = {
                    price: 100,
                    coverage: 1,
                    pageName: `第 ${pageNumber} 页`
                };
            }
            
            const numValue = parseFloat(value) || 0;
            if (numValue <= 0) {
                showToast('参数值必须大于0', 'warning');
                return;
            }
            
            pdfPageParameters[pageNumber][paramName] = numValue;
            console.log(`更新PDF页面 ${pageNumber} 的参数 ${paramName}:`, pdfPageParameters[pageNumber][paramName]);
            
            // 如果是当前页面，更新当前页面参数显示
            if (pageNumber === currentPdfPage) {
                updateCurrentPdfPageParameters();
            }
            
            // 参数已保存，等待用户手动计算
            showToast('参数已保存', 'success');
        }

        // 更新当前PDF页面参数显示
        function updateCurrentPdfPageParameters() {
            if (!pdfPageParameters[currentPdfPage]) return;
            
            const params = pdfPageParameters[currentPdfPage];
            document.getElementById('pdfCurrentInkPrice').value = params.price || 100;
            document.getElementById('pdfCurrentInkCoverage').value = params.coverage || 1;
            document.getElementById('pdfPageParameters').classList.remove('hidden');
        }

        // 开始编辑PDF文件名
        function startEditPdfFileName() {
            const displayElement = document.getElementById('pdfFileNameDisplay');
            const editElement = document.getElementById('pdfFileNameEdit');
            const inputElement = document.getElementById('pdfFileNameInput');
            
            if (window.currentPdfFile) {
                inputElement.value = window.currentPdfFile.displayName;
                displayElement.classList.add('hidden');
                editElement.classList.remove('hidden');
                inputElement.focus();
                inputElement.select();
            }
        }

        // 保存PDF文件名
        function savePdfFileName() {
            const inputElement = document.getElementById('pdfFileNameInput');
            const newName = inputElement.value.trim();
            
            if (window.currentPdfFile && newName) {
                window.currentPdfFile.displayName = newName;
                document.getElementById('pdfFileNameDisplay').textContent = newName;
            }
            
            document.getElementById('pdfFileNameDisplay').classList.remove('hidden');
            document.getElementById('pdfFileNameEdit').classList.add('hidden');
        }

        // 开始编辑PDF页面名称
        function startEditPdfPageName(pageNumber) {
            const displayElement = document.getElementById(`pdfPageNameDisplay_${pageNumber}`);
            const editElement = document.getElementById(`pdfPageNameEdit_${pageNumber}`);
            const inputElement = document.getElementById(`pdfPageNameInput_${pageNumber}`);
            
            displayElement.classList.add('hidden');
            editElement.classList.remove('hidden');
            inputElement.focus();
            inputElement.select();
        }

        // 保存PDF页面名称
        function savePdfPageName(pageNumber) {
            const inputElement = document.getElementById(`pdfPageNameInput_${pageNumber}`);
            const newName = inputElement.value.trim();
            
            if (pdfPageParameters[pageNumber]) {
                pdfPageParameters[pageNumber].pageName = newName || `第 ${pageNumber} 页`;
                document.getElementById(`pdfPageNameDisplay_${pageNumber}`).textContent = pdfPageParameters[pageNumber].pageName;
                
                console.log(`页面${pageNumber}名称已更新为:`, pdfPageParameters[pageNumber].pageName);
                
                // 重新排序页面列表
                sortAndUpdatePdfPageList();
            }
            
            document.getElementById(`pdfPageNameDisplay_${pageNumber}`).classList.remove('hidden');
            document.getElementById(`pdfPageNameEdit_${pageNumber}`).classList.add('hidden');
        }
        
        // 按名称排序PDF页面列表
        function sortPdfPageListByName() {
            console.log('开始检测当前页面名称并重新排序...');
            
            const pageList = document.getElementById('pdfPageList');
            
            // 创建页面信息数组用于排序
            const pages = [];
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                pages.push({
                    pageNum: i,
                    pageName: pdfPageParameters[i]?.pageName || '未识别成功'
                });
            }
            
            // 按页面名称排序
            pages.sort((a, b) => {
                // 优先按名称排序，"未识别成功"排在最后
                if (a.pageName === '未识别成功' && b.pageName !== '未识别成功') return 1;
                if (a.pageName !== '未识别成功' && b.pageName === '未识别成功') return -1;
                return a.pageName.localeCompare(b.pageName, 'zh-CN');
            });
            
            console.log('排序后的页面列表:', pages);
            
            // 保存当前选中的页面
            const selectedPage = currentPdfPage;
            
            // 清空当前列表
            pageList.innerHTML = '';
            
            // 按排序后的顺序重新生成页面列表
            pages.forEach(pageInfo => {
                const i = pageInfo.pageNum;
                const params = pdfPageParameters[i] || {
                    price: 100,
                    coverage: 30,
                    pageName: `第 ${i} 页`
                };
                
                const pageItem = document.createElement('div');
                pageItem.className = 'bg-white rounded-lg shadow-sm border border-gray-200 mb-3 cursor-pointer hover:shadow-md transition-shadow';
                pageItem.setAttribute('data-page', i);
                const pageNum = i;
                pageItem.onclick = () => viewPdfPage(pageNum);
                
                // 设置页面内容
                pageItem.innerHTML = `
                    <div class="flex items-center justify-between p-3 border-b border-gray-200">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="w-8 h-8 bg-primary/10 rounded flex items-center justify-center mr-3">
                                <i class="fa fa-file-pdf-o text-primary"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div id="pdfPageNameDisplay_${i}" class="text-sm font-medium truncate cursor-pointer hover:text-primary" onclick="event.stopPropagation(); startEditPdfPageName(${i})">
                                    <span class="${params.pageName !== '未识别成功' ? 'text-gray-900' : 'text-gray-400 italic'}">
                                        ${params.pageName === '未识别成功' ? '未识别成功请手动填写' : params.pageName}
                                    </span>
                                </div>
                                <div id="pdfPageNameEdit_${i}" class="hidden">
                                    <input type="text" id="pdfPageNameInput_${i}" value="${params.pageName === '未识别成功' ? '' : params.pageName}" 
                                           placeholder="请输入页面名称"
                                           class="w-full text-xs border border-blue-300 rounded px-1 py-0.5 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           onkeydown="if(event.key === 'Enter') { event.stopPropagation(); savePdfPageName(${i}); }"
                                           onblur="savePdfPageName(${i});">
                                </div>
                                <p class="text-xs text-gray-500">PDF页面</p>
                            </div>
                            
                            
                            
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); startEditPdfPageName(${i})" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded"
                                    title="编辑页面名称">
                                <i class="fa fa-pencil text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div id="pdf_params_${i}" class="bg-gray-50 p-2 border-t border-gray-200" onclick="event.stopPropagation()">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">油墨价格 (元/kg)</label>
                                <input type="number" id="pdf_inkPrice_${i}" step="0.01" min="0.01" value="${params.price}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'price', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">覆盖面积 (m²/kg)</label>
                                <input type="number" id="pdf_inkCoverage_${i}" step="0.01" min="0.01" value="${params.coverage}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'coverage', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                `;
                
                pageList.appendChild(pageItem);
            });
            
            // 重新应用选中状态
            setTimeout(() => {
                updatePdfPageListSelection();
            }, 100);
            
            console.log('页面列表重新排序完成');
        }
        
        // 重新排序并更新PDF页面列表
        function sortAndUpdatePdfPageList() {
            console.log('开始重新排序页面列表...');
            
            const pageList = document.getElementById('pdfPageList');
            
            // 创建页面信息数组用于排序
            const pages = [];
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                pages.push({
                    pageNum: i,
                    pageName: pdfPageParameters[i]?.pageName || '未识别成功'
                });
            }
            
            // 按页面名称排序
            pages.sort((a, b) => {
                // 优先按名称排序，"未识别成功"排在最后
                if (a.pageName === '未识别成功' && b.pageName !== '未识别成功') return 1;
                if (a.pageName !== '未识别成功' && b.pageName === '未识别成功') return -1;
                return a.pageName.localeCompare(b.pageName, 'zh-CN');
            });
            
            console.log('重新排序后的页面列表:', pages);
            
            // 保存当前选中的页面
            const selectedPage = currentPdfPage;
            
            // 清空当前列表
            const currentItems = pageList.innerHTML;
            pageList.innerHTML = '';
            
            // 按排序后的顺序重新生成页面列表
            pages.forEach(pageInfo => {
                const i = pageInfo.pageNum;
                const params = pdfPageParameters[i] || {
                    price: 100,
                    coverage: 30,
                    pageName: `第 ${i} 页`
                };
                
                const pageItem = document.createElement('div');
                pageItem.className = 'bg-white rounded-lg shadow-sm border border-gray-200 mb-3 cursor-pointer hover:shadow-md transition-shadow';
                pageItem.setAttribute('data-page', i);
                const pageNum = i;
                pageItem.onclick = () => viewPdfPage(pageNum);
                
                // 设置与原始页面相同的HTML内容
                pageItem.innerHTML = `
                    <div class="flex items-center justify-between p-3 border-b border-gray-200">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="w-8 h-8 bg-primary/10 rounded flex items-center justify-center mr-3">
                                <i class="fa fa-file-pdf-o text-primary"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div id="pdfPageNameDisplay_${i}" class="text-sm font-medium truncate cursor-pointer hover:text-primary" onclick="event.stopPropagation(); startEditPdfPageName(${i})">
                                    <span class="${params.pageName !== '未识别成功' ? 'text-gray-900' : 'text-gray-400 italic'}">
                                        ${params.pageName === '未识别成功' ? '未识别成功请手动填写' : params.pageName}
                                    </span>
                                </div>
                                <div id="pdfPageNameEdit_${i}" class="hidden">
                                    <input type="text" id="pdfPageNameInput_${i}" value="${params.pageName === '未识别成功' ? '' : params.pageName}" 
                                           placeholder="请输入页面名称"
                                           class="w-full text-xs border border-blue-300 rounded px-1 py-0.5 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           onkeydown="if(event.key === 'Enter') { event.stopPropagation(); savePdfPageName(${i}); }"
                                           onblur="savePdfPageName(${i});">
                                </div>
                                <p class="text-xs text-gray-500">PDF页面</p>
                            </div>
                            
                            
                            
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); startEditPdfPageName(${i})" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded"
                                    title="编辑页面名称">
                                <i class="fa fa-pencil text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div id="pdf_params_${i}" class="bg-gray-50 p-2 border-t border-gray-200" onclick="event.stopPropagation()">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">油墨价格 (元/kg)</label>
                                <input type="number" id="pdf_inkPrice_${i}" step="0.01" min="0.01" value="${params.price}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'price', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">覆盖面积 (m²/kg)</label>
                                <input type="number" id="pdf_inkCoverage_${i}" step="0.01" min="0.01" value="${params.coverage}"
                                       onchange="event.stopPropagation(); updatePdfPageParam(${i}, 'coverage', this.value)"
                                       oninput="if(this.value < 0.01) this.value = 0.01"
                                       class="w-full px-1 py-0.5 border border-gray-300 rounded text-xs" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                `;
                
                pageList.appendChild(pageItem);
            });
            
            // 重新应用选中状态
            setTimeout(() => {
                updatePdfPageListSelection();
            }, 100);
            
            console.log('页面列表重新排序完成');
        }

        // 删除PDF
        function removePdf() {
            pdfDocument = null;
            currentPdfPage = 1;
            pdfZoom = 1.0;
            pdfCalculationResults = [];
            pdfPageParameters = {};
            window.currentPdfFile = null;
            
            // 使用与上传时相同的重置函数来确保所有元素都被正确重置
            const resetElementVisibility = (elementId, action, className) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList[action](className);
                } else {
                    console.warn(`元素 ${elementId} 不存在，跳过状态重置`);
                }
            };
            
            // 重置所有元素的可见性
            resetElementVisibility('pdfPreview', 'add', 'hidden');
            resetElementVisibility('pdfInfo', 'add', 'hidden');
            resetElementVisibility('pdfDetails', 'add', 'hidden');
            resetElementVisibility('pdfResults', 'add', 'hidden');
            resetElementVisibility('noPdfPreview', 'remove', 'hidden');
            resetElementVisibility('pdfNavigation', 'add', 'hidden');
            resetElementVisibility('pdfZoomControls', 'add', 'hidden');
            resetElementVisibility('pdfCurrentPageTitle', 'add', 'hidden');
            resetElementVisibility('pdfBatchResults', 'add', 'hidden');
            resetElementVisibility('pdfSummary', 'add', 'hidden');
            resetElementVisibility('pdfCalculationDetails', 'add', 'hidden');
            resetElementVisibility('pdfPaperSummary', 'add', 'hidden');
            resetElementVisibility('pdfPageSelector', 'add', 'hidden');
            resetElementVisibility('calculationProgressContainer', 'add', 'hidden');
            resetElementVisibility('pdfInfoSection', 'add', 'hidden');
            resetElementVisibility('calculationParameters', 'add', 'hidden');
            resetElementVisibility('calculateAllPagesBtn', 'add', 'hidden');
            resetElementVisibility('pdfSummary', 'add', 'hidden');
            resetElementVisibility('pdfCalculationDetails', 'add', 'hidden');
            resetElementVisibility('pdfPaperSummary', 'add', 'hidden');
            resetElementVisibility('pdfPageSelector', 'add', 'hidden');
            resetElementVisibility('calculationProgressContainer', 'add', 'hidden');
            resetElementVisibility('pdfInfoSection', 'add', 'hidden');
            resetElementVisibility('calculationParameters', 'add', 'hidden');
            
            // 清空文件输入
            document.getElementById('pdfUpload').value = '';
            
            // 清空页面列表和计算表格
            document.getElementById('pdfPageList').innerHTML = '';
            document.getElementById('pdfPageCount').textContent = '0';
            
            // 清空计算表格内容
            const tableBody = document.getElementById('pdfCalculationTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            
            const tableFooter = document.getElementById('pdfCalculationTableFooter');
            if (tableFooter) {
                tableFooter.innerHTML = '';
            }
            
            // 重置显示内容
            document.getElementById('pdfCurrentPage').textContent = '-';
            document.getElementById('pdfPageSize').textContent = '-';
            document.getElementById('pdfFileNameDisplay').textContent = '';
            document.getElementById('pdfFileSize').textContent = '';
            
            // 重置计算结果显示
            document.getElementById('pdfInkAreaResult').textContent = '- cm²';
            document.getElementById('pdfInkWeightResult').textContent = '- g';
            document.getElementById('pdfInkCostResult').textContent = '- 元';
            document.getElementById('pdfUnitCostResult').textContent = '- 元';
            
            // 重置预览信息显示
            document.getElementById('pdfPreviewPixelSize').textContent = '-';
            document.getElementById('pdfPreviewActualSize').textContent = '-';
            document.getElementById('pdfPreviewInkArea').textContent = '- cm²';
            
            // 禁用计算按钮
            const calculateBtn = document.getElementById('calculateAllPagesBtn');
            if (calculateBtn) {
                calculateBtn.disabled = true;
                calculateBtn.classList.add('hidden');
            }
            
            showToast('PDF文件已删除', 'success');
        }

        // 计算所有PDF页面
        function calculateAllPdfPages() {
            if (!pdfDocument) {
                showToast('请先上传PDF文件', 'error');
                return;
            }
            
            const totalPages = pdfDocument.numPages;
            let processedPages = 0;
            pdfCalculationResults = [];
            
            // 显示计算进度
            document.getElementById('pdfCalculationProgress').classList.remove('hidden');
            document.getElementById('calculationProgressContainer').classList.remove('hidden');
            updatePdfProgress(processedPages, totalPages);
            
            // 处理所有页面
            processPagesSequentially();
            
            function processPagesSequentially() {
                function processNext(pageNumber) {
                    if (pageNumber > totalPages) {
                        // 所有页面处理完成
                        completePdfProcessing();
                        return;
                    }
                    
                    processPdfPage(pageNumber).then(result => {
                        pdfCalculationResults.push(result);
                        processedPages++;
                        
                        // 更新进度
                        updatePdfProgress(processedPages, totalPages);
                        
                        // 继续处理下一个页面
                        setTimeout(() => {
                            processNext(pageNumber + 1);
                        }, 10);
                    }).catch(error => {
                        console.error(`处理PDF页面 ${pageNumber} 时发生错误:`, error);
                        processedPages++;
                        updatePdfProgress(processedPages, totalPages);
                        
                        // 即使出错也要继续处理下一个页面
                        setTimeout(() => {
                            processNext(pageNumber + 1);
                        }, 10);
                    });
                }
                
                // 开始处理第一个页面
                processNext(1);
            }
            
            function completePdfProcessing() {
                document.getElementById('pdfCalculationProgress').classList.add('hidden');
                document.getElementById('calculationProgressContainer').classList.add('hidden');
                
                if (pdfCalculationResults.length === totalPages) {
                    showToast(`PDF批量计算完成！共处理 ${totalPages} 页`, 'success');
                } else {
                    showToast(`PDF批量计算完成，但有 ${totalPages - pdfCalculationResults.length} 页处理失败`, 'warning');
                }
                
                // 确保有计算结果后再显示
                if (pdfCalculationResults.length > 0) {
                    // 优先显示当前页面的结果，如果当前页面没有结果则显示第一个有结果的页面
                    const currentResult = pdfCalculationResults.find(r => r.pageNumber === currentPdfPage) || pdfCalculationResults[0];
                    if (currentResult) {
                        displayPdfResult(currentResult);
                    }
                }
            }
        }

        // 处理单个PDF页面
        function processPdfPage(pageNumber) {
            return new Promise((resolve, reject) => {
                try {
                    pdfDocument.getPage(pageNumber).then(page => {
                        try {
                            // 创建canvas用于像素分析
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            
                            // 渲染PDF页面到canvas
                            const renderContext = {
                                canvasContext: ctx,
                                viewport: viewport
                            };
                            
                            page.render(renderContext).promise.then(() => {
                                try {
                                    // 获取像素数据
                                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                    const data = imageData.data;
                                    
                                    // 计算油墨像素
                                    let blackPixelCount = 0;
                                    for (let i = 0; i < data.length; i += 4) {
                                        const r = data[i];
                                        const g = data[i + 1];
                                        const b = data[i + 2];
                                        
                                        // 简单的黑白判断
                                        if ((r + g + b) / 3 < 128) {
                                            blackPixelCount++;
                                        }
                                    }
                                    
                                    // 计算覆盖率
                                    const totalPixels = canvas.width * canvas.height;
                                    const coverage = (blackPixelCount / totalPixels) * 100;
                                    
                                    // 计算实际尺寸（毫米）
                                    const dpi = 72; // PDF标准DPI
                                    let widthMm = (canvas.width / dpi) * 25.4;
                                    let heightMm = (canvas.height / dpi) * 25.4;
                                    
                                    // 四舍五入到两位小数，确保显示一致性
                                    widthMm = Math.round(widthMm * 100) / 100;
                                    heightMm = Math.round(heightMm * 100) / 100;
                                    
                                    // 计算面积（平方米）
                                    const totalArea = (widthMm * heightMm) / 1000000;
                                    const inkArea = totalArea * (coverage / 100);
                                    
                                    // 获取页面参数
                                    const params = pdfPageParameters[pageNumber] || { price: 100, coverage: 1 };
                                    const inkPrice = params.price || 100;
                                    const inkCoverage = params.coverage || 1;
                                    
                                    // 获取计算参数
                                    const layoutCount = parseInt(document.getElementById('pdfLayoutCountInput').value) || 1;
                                    const orderCount = parseInt(document.getElementById('pdfOrderCount').value) || 1;
                                    const paperPrice = parseFloat(document.getElementById('pdfPaperPrice').value) || 0;
                                    const paperMultiplier = parseFloat(document.getElementById('pdfPaperMultiplier').value) || 1.03;
                                    const laborCost = parseFloat(document.getElementById('pdfLaborCost').value) || 0;
                                    // 计算成本
                                    const inkWeight = inkArea / inkCoverage;
                                    const inkCost = inkWeight * inkPrice; // 直接计算油墨成本，不考虑排版数量和订单数量
                                    
                                    // 计算单个体成本（用于兼容性）
                                    const unitCost = (inkWeight * inkPrice) / layoutCount;
                                    
                                    // 计算金膜用量和成本
                                    const pageWidth = 0.5; // 页面宽度固定为0.5米
                                    // 计算总纸张用量
                                    const totalPaperUsage = (orderCount / layoutCount) * paperMultiplier;
                                    
                                    // 获取所有金膜参数
                                    const goldFilmRows = document.querySelectorAll('.gold-film-row');
                                    const goldFilmResults = [];
                                    
                                    goldFilmRows.forEach((row) => {
                                        // 使用属性选择器获取输入框，不依赖于固定索引
                                        const nameInput = row.querySelector('input[id^="pdfGoldFilmName_"]');
                                        const priceInput = row.querySelector('input[id^="pdfGoldFilmPrice_"]');
                                        const lengthInput = row.querySelector('input[id^="pdfGoldFilmLength_"]');
                                        
                                        if (nameInput && priceInput && lengthInput) {
                                            const goldFilmName = nameInput.value || `金膜${goldFilmResults.length + 1}`;
                                            const goldFilmPrice = parseFloat(priceInput.value) || 0;
                                            const goldFilmLength = parseFloat(lengthInput.value) || 1200;
                                            
                                            // 计算金膜用量和成本
                                            const goldFilmNeededLengthRaw = totalPaperUsage * pageWidth;
                                            const goldFilmNeededLength = Math.ceil(goldFilmNeededLengthRaw); // 金膜米数向上取整
                                            const goldFilmRolls = goldFilmPrice > 0 && goldFilmLength > 0 ? Math.ceil(goldFilmNeededLength / goldFilmLength) : 0;
                                            const goldFilmCost = goldFilmRolls * goldFilmPrice;
                                            
                                            goldFilmResults.push({
                                                name: goldFilmName,
                                                price: goldFilmPrice,
                                                length: goldFilmLength,
                                                neededLength: goldFilmNeededLength,
                                                rolls: goldFilmRolls,
                                                cost: goldFilmCost
                                            });
                                        }
                                    });
                                    
                                    console.log('金膜参数收集结果:', goldFilmResults);
                                    
                                    const result = {
                                        pageNumber: pageNumber,
                                        pageName: params.pageName || `第 ${pageNumber} 页`,
                                        fileName: window.currentPdfFile?.displayName || '未知PDF文件',
                                        pixelSize: `${canvas.width} × ${canvas.height}`,
                                        actualSize: `${parseFloat(widthMm.toFixed(10))} × ${parseFloat(heightMm.toFixed(10))} mm`,
                                        paperPrice: paperPrice,
                                        paperMultiplier: paperMultiplier,
                                        laborCost: laborCost,
                                        totalArea: totalArea,
                                        inkArea: inkArea,
                                        coverage: coverage,
                                        inkWeight: inkWeight,
                                        inkCost: inkCost,
                                        unitCost: unitCost,
                                        layoutCount: layoutCount,
                                        orderCount: orderCount,
                                        inkPrice: inkPrice,
                                        inkCoverage: inkCoverage,
                                        goldFilmResults: goldFilmResults,
                                        totalPaperUsage: totalPaperUsage
                                    };
                                    
                                    resolve(result);
                                } catch (error) {
                                    reject(error);
                                }
                            }).catch(error => {
                                reject(error);
                            });
                        } catch (error) {
                            reject(error);
                        }
                    }).catch(error => {
                        reject(error);
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 显示PDF计算结果
        function displayPdfResult(result) {
            if (!result) return;
            
            // 更新页面选择器
            updatePdfPageSelector();
            
            // 显示当前页面的详细信息
            updateDetailPageDisplay(result);
            
            // 生成计算结果表格
            generateCalculationTable();
            
            // 更新纸张汇总信息
            updatePaperSummary();
            
            // 显示详细计算参数和结果区域
            document.getElementById('pdfCalculationDetails').classList.remove('hidden');
            document.getElementById('pdfPaperSummary').classList.remove('hidden');
            document.getElementById('pdfResults').classList.remove('hidden');
        }
        
        // 更新页面选择器
        function updatePdfPageSelector() {
            const selector = document.getElementById('pdfDetailPageSelector');
            const selectorContainer = document.getElementById('pdfPageSelector');
            
            // 清空现有选项
            selector.innerHTML = '';
            
            if (pdfCalculationResults.length === 0) {
                selectorContainer.classList.add('hidden');
                return;
            }
            
            // 添加所有已计算页面的选项
            pdfCalculationResults.forEach(result => {
                const option = document.createElement('option');
                option.value = result.pageNumber;
                option.textContent = `${result.pageName} (第${result.pageNumber}页)`;
                option.selected = result.pageNumber === currentPdfPage;
                selector.appendChild(option);
            });
            
            // 显示选择器
            selectorContainer.classList.remove('hidden');
        }
        
        // 切换详细页面显示
        function switchDetailPage(pageNumber) {
            const pageNum = parseInt(pageNumber);
            const result = pdfCalculationResults.find(r => r.pageNumber === pageNum);
            
            if (result) {
                // 更新当前页码
                currentPdfPage = pageNum;
                document.getElementById('pdfCurrentPage').textContent = currentPdfPage;
                
                // 更新详细信息显示
                updateDetailPageDisplay(result);
                
                // 重新渲染PDF页面
                renderPdfPage(currentPdfPage);
                
                // 更新页面列表选中状态
                updatePdfPageListSelection();
                
                // 更新导航按钮状态
                updatePdfNavigationButtons();
                
                // 重新生成计算结果表格以高亮当前页面
                generateCalculationTable();
                
                showToast(`已切换到第 ${pageNum} 页的详细信息`, 'success');
            }
        }
        
        // 更新详细页面显示
        function updateDetailPageDisplay(result) {
            if (!result) return;
            
            // 更新详细计算参数显示
            document.getElementById('pdfDetailFileName').textContent = result.fileName;
            document.getElementById('pdfDetailPageName').textContent = result.pageName;
            document.getElementById('pdfDetailPageNumber').textContent = `${result.pageNumber}/${pdfDocument.numPages}`;
            document.getElementById('pdfDetailPixelSize').textContent = result.pixelSize;
            document.getElementById('pdfDetailActualSize').textContent = result.actualSize;
            document.getElementById('pdfDetailInkPrice').textContent = result.inkPrice + ' 元/kg';
            document.getElementById('pdfDetailInkCoverage').textContent = result.inkCoverage + ' m²/kg';
            document.getElementById('pdfDetailLayoutCount').textContent = result.layoutCount + ' 个/版';
            document.getElementById('pdfDetailOrderCount').textContent = result.orderCount + ' 个';
            document.getElementById('pdfDetailLaborCost').textContent = (result.laborCost || 0).toFixed(2) + ' 元';
        }
        
        // 更新纸张汇总信息
        function updatePaperSummary() {
            // 计算总纸张用量和成本
            let totalPaperCount = 0;
            let totalPaperCost = 0;
            let totalLaborCost = 0;
            
            // 获取第一个结果的参数来计算纸张和金膜用量（不考虑页面数量）
            if (pdfCalculationResults.length > 0) {
                const firstResult = pdfCalculationResults[0];
                // 订单数量 ÷ 花纸排版数量 × 纸张放数，向上取整
                totalPaperCount = Math.ceil((firstResult.orderCount / firstResult.layoutCount) * firstResult.paperMultiplier);
                totalPaperCost = totalPaperCount * firstResult.paperPrice;
                
                // 计算人工水电成本：总纸张用量 × 人工水电价格
                totalLaborCost = totalPaperCount * (firstResult.laborCost || 0);
                
                // 更新金膜信息显示
                const goldFilmInfoContainer = document.getElementById('pdfGoldFilmInfo');
                goldFilmInfoContainer.innerHTML = '';
                
                if (firstResult.goldFilmResults && firstResult.goldFilmResults.length > 0) {
                    firstResult.goldFilmResults.forEach((goldFilm, index) => {
                        const goldFilmDiv = document.createElement('div');
                        goldFilmDiv.className = `mb-2 ${index > 0 ? 'border-t pt-2' : ''}`;
                        
                        // 计算实际使用成本：金膜价格 ÷ 金膜长度 × 实际使用米数
                        const goldFilmLength = goldFilm.length || 100; // 假设金膜长度为100米/卷
                        const actualUsageCost = (goldFilm.price / goldFilmLength) * goldFilm.neededLength;
                        
                        goldFilmDiv.innerHTML = `
                            <div class="text-base font-medium text-gray-900 mb-2">${goldFilm.name}</div>
                            <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">
                                <div class="flex items-center">
                                    <span class="font-medium w-16">用量:</span>
                                    <span>${goldFilm.rolls.toFixed(2)} 卷 (${goldFilm.neededLength.toFixed(2)} 米)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-medium w-16">单价:</span>
                                    <span>${goldFilm.price.toFixed(2)} 元/卷</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-medium w-16">成本:</span>
                                    <span class="font-bold text-blue-600">${goldFilm.cost.toFixed(2)} 元</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm text-gray-700 mt-2">
                                <div class="flex items-center">
                                    <span class="font-medium w-16">卷长度:</span>
                                    <span>${goldFilmLength.toFixed(0)} 米/卷</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-medium w-16">米单价:</span>
                                    <span>${(goldFilm.price / goldFilmLength).toFixed(4)} 元/米</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-medium w-16">实际成本:</span>
                                    <span class="font-bold text-green-600">${actualUsageCost.toFixed(2)} 元</span>
                                </div>
                            </div>
                        `;
                        
                        goldFilmInfoContainer.appendChild(goldFilmDiv);
                    });
                } else {
                    goldFilmInfoContainer.innerHTML = '<div class="text-sm text-gray-500">暂无金膜数据</div>';
                }
                
                // 计算最终结果
                calculateFinalResults(firstResult, totalLaborCost, totalPaperCount);
            }
            
            // 更新显示
            document.getElementById('pdfTotalPaperCount').textContent = totalPaperCount.toFixed(2) + ' 张';
            document.getElementById('pdfTotalPaperCost').textContent = totalPaperCost.toFixed(2) + ' 元';
            
            // 更新人工水电信息显示
            if (pdfCalculationResults.length > 0) {
                const firstResult = pdfCalculationResults[0];
                document.getElementById('pdfLaborPrice').textContent = (firstResult.laborCost || 0).toFixed(2) + ' 元/张';
                document.getElementById('pdfLaborCount').textContent = totalPaperCount.toFixed(2) + ' 张';
                document.getElementById('pdfLaborTotalCost').textContent = totalLaborCost.toFixed(2) + ' 元';
            }
        }
        
        // 计算最终结果
        function calculateFinalResults(result, totalLaborCost, totalPaperCount) {
            console.log('开始计算最终结果...');
            
            // 计算油墨总成本（所有页面的油墨成本之和）
            const totalInkCost = pdfCalculationResults.reduce((sum, r) => sum + r.inkCost, 0);
            console.log('油墨总成本:', totalInkCost);
            
            // 计算单张纸的人工水电成本
            const singleLaborCost = result.laborCost || 0;
            console.log('单张纸人工水电成本:', singleLaborCost);
            
            // 计算金膜总成本
            let totalGoldFilmCost = 0;
            let actualGoldFilmCost = 0;
            if (result.goldFilmResults && result.goldFilmResults.length > 0) {
                totalGoldFilmCost = result.goldFilmResults.reduce((sum, goldFilm) => sum + goldFilm.cost, 0);
                
                // 计算金膜实际成本：金膜价格 ÷ 金膜长度 × 实际使用米数
                actualGoldFilmCost = result.goldFilmResults.reduce((sum, goldFilm) => {
                    const goldFilmLength = goldFilm.length || 100; // 假设金膜长度为100米/卷
                    return sum + (goldFilm.price / goldFilmLength) * goldFilm.neededLength;
                }, 0);
            }
            console.log('金膜总成本:', totalGoldFilmCost);
            console.log('金膜实际成本:', actualGoldFilmCost);
            
            // 避免除以0的情况
            const safeTotalPaperCount = totalPaperCount > 0 ? totalPaperCount : 1;
            const singleLaborCostPerPaper = totalLaborCost / safeTotalPaperCount;
            
            // 计算单张纸价格（新方式）：油墨总成本+纸张单价+加人工单水电单价+金膜总成本除以总纸张用量
            const paperPrice = result.paperPrice || 0;
            const singleGoldFilmCostPerPaper = totalGoldFilmCost / safeTotalPaperCount;
            const singlePaperPrice = totalInkCost + paperPrice + singleLaborCost + singleGoldFilmCostPerPaper;
            
            // 计算单张纸价格（实际金膜用量）：油墨总成本+纸张单价+加人工单水电单价+金膜实际成本除以总纸张用量
            const singleActualGoldFilmCostPerPaper = actualGoldFilmCost / safeTotalPaperCount;
            const singlePaperPriceActual = totalInkCost + paperPrice + singleLaborCost + singleActualGoldFilmCostPerPaper;
            
            console.log('单张纸价格计算：');
            console.log('- 油墨总成本:', totalInkCost);
            console.log('- 纸张单价:', paperPrice);
            console.log('- 人工水电单价:', singleLaborCost);
            console.log('- 金膜成本/张:', singleGoldFilmCostPerPaper);
            console.log('- 单张纸总价:', singlePaperPrice);
            
            console.log('单张纸人工水电成本:', singleLaborCost);
            console.log('单张金膜成本:', singleGoldFilmCostPerPaper);
            console.log('实际金膜成本/张:', singleActualGoldFilmCostPerPaper);
            console.log('单张纸价格:', singlePaperPrice);
            console.log('单张纸价格（实际金膜用量）:', singlePaperPriceActual);
            
            // 计算单个花纸价格
            const singleLabelPrice = result.layoutCount > 0 ? singlePaperPrice / result.layoutCount : 0;
            const singleLabelPriceActual = result.layoutCount > 0 ? singlePaperPriceActual / result.layoutCount : 0;
            
            console.log('花纸排版数量:', result.layoutCount);
            console.log('单个花纸价格:', singleLabelPrice);
            console.log('单个花纸价格（实际金膜用量）:', singleLabelPriceActual);
            
            // 更新最终结果显示
            updateFinalResultDisplay({
                totalInkCost,
                singleLaborCost,
                totalLaborCost,
                totalGoldFilmCost,
                actualGoldFilmCost,
                singlePaperPrice,
                singlePaperPriceActual,
                singleLabelPrice,
                singleLabelPriceActual,
                layoutCount: result.layoutCount,
                totalPaperUsage: safeTotalPaperCount,
                paperPrice: result.paperPrice || 0,
                goldFilmResults: result.goldFilmResults || []
            });
        }
        
        // 更新最终结果显示
        function updateFinalResultDisplay(data) {
            console.log('更新最终结果显示:', data);
            if (!data) {
                console.error('数据为空，无法更新结果显示');
                return;
            }
            
            // 生成动态计算过程
            let calculationProcess = `
                <div class="space-y-2">
            `;
            
            // 1. 金膜实际成本计算（支持多个金膜）
            if (data.goldFilmResults && data.goldFilmResults.length > 0) {
                calculationProcess += `
                    <div class="font-medium">1. 金膜实际成本计算：</div>
                `;
                
                data.goldFilmResults.forEach((goldFilm, index) => {
                    calculationProcess += `
                        <div class="ml-4">${goldFilm.name}：</div>
                        <div class="ml-8">= ` + goldFilm.price.toFixed(2) + `<span class="text-gray-500 ml-1">（金膜价格：元/卷）</span> ÷ ` + goldFilm.length + `<span class="text-gray-500 ml-1">（金膜长度：米）</span> × ` + goldFilm.neededLength.toFixed(2) + `<span class="text-gray-500 ml-1">（实际使用米数）</span></div>
                        <div class="ml-8">= ` + (goldFilm.price / goldFilm.length).toFixed(4) + `<span class="text-gray-500 ml-1">（元/米）</span> × ` + goldFilm.neededLength.toFixed(2) + `<span class="text-gray-500 ml-1">（米）</span></div>
                        <div class="ml-8">= ` + goldFilm.cost.toFixed(2) + `<span class="text-gray-500 ml-1">（元）</span></div>
                    `;
                });
                
                calculationProcess += `
                    <div class="font-medium mt-2">金膜实际成本合计：</div>
                    <div class="ml-4">= <span class="font-medium text-green-600">` + data.actualGoldFilmCost.toFixed(2) + ` 元</span><span class="text-gray-500 ml-1">（金膜实际总成本）</span></div>
                `;
            }
            
            // 2. 单张纸价格计算
            calculationProcess += `
                <div class="font-medium mt-3">2. 单张纸价格计算：</div>
                <div>= ` + data.totalInkCost.toFixed(2) + `<span class="text-gray-500 ml-1">（油墨总成本：元）</span> + ` + (data.paperPrice || 0).toFixed(2) + `<span class="text-gray-500 ml-1">（纸张单价：元/张）</span> + ` + data.singleLaborCost.toFixed(2) + `<span class="text-gray-500 ml-1">（人工水电单价：元/张）</span> + (` + data.totalGoldFilmCost.toFixed(2) + `<span class="text-gray-500 ml-1">（金膜总成本：元）</span> ÷ ` + data.totalPaperUsage + `<span class="text-gray-500 ml-1">（纸张总用量：张）</span>)</div>
                <div>= ` + data.totalInkCost.toFixed(2) + `<span class="text-gray-500 ml-1">（元）</span> + ` + (data.paperPrice || 0).toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span> + ` + data.singleLaborCost.toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span> + ` + (data.totalGoldFilmCost / data.totalPaperUsage).toFixed(4) + `<span class="text-gray-500 ml-1">（元/张）</span></div>
                <div>= ` + (data.totalInkCost + (data.paperPrice || 0) + data.singleLaborCost + data.totalGoldFilmCost / data.totalPaperUsage).toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span></div>
                <div>= <span class="font-medium text-blue-600">` + data.singlePaperPrice.toFixed(2) + ` 元/张</span><span class="text-gray-500 ml-1">（单张纸价格）</span></div>
                
                <div class="font-medium mt-3">3. 单张纸成本（实际金膜用量）计算：</div>
                <div>= ` + data.totalInkCost.toFixed(2) + `<span class="text-gray-500 ml-1">（油墨总成本：元）</span> + ` + (data.paperPrice || 0).toFixed(2) + `<span class="text-gray-500 ml-1">（纸张单价：元/张）</span> + ` + data.singleLaborCost.toFixed(2) + `<span class="text-gray-500 ml-1">（人工水电单价：元/张）</span> + (` + data.actualGoldFilmCost.toFixed(2) + `<span class="text-gray-500 ml-1">（金膜实际成本：元）</span> ÷ ` + data.totalPaperUsage + `<span class="text-gray-500 ml-1">（纸张总用量：张）</span>)</div>
                <div>= ` + data.totalInkCost.toFixed(2) + `<span class="text-gray-500 ml-1">（元）</span> + ` + (data.paperPrice || 0).toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span> + ` + data.singleLaborCost.toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span> + ` + (data.actualGoldFilmCost / data.totalPaperUsage).toFixed(4) + `<span class="text-gray-500 ml-1">（元/张）</span></div>
                <div>= ` + (data.totalInkCost + (data.paperPrice || 0) + data.singleLaborCost + data.actualGoldFilmCost / data.totalPaperUsage).toFixed(2) + `<span class="text-gray-500 ml-1">（元/张）</span></div>
                <div>= <span class="font-medium text-purple-600">` + data.singlePaperPriceActual.toFixed(2) + ` 元/张</span><span class="text-gray-500 ml-1">（单张纸成本：实际金膜用量）</span></div>
                
                <div class="font-medium mt-3">4. 单个花纸价格计算：</div>
                <div>= ` + data.singlePaperPrice.toFixed(2) + `<span class="text-gray-500 ml-1">（单张纸价格：元/张）</span> ÷ ` + data.layoutCount + `<span class="text-gray-500 ml-1">（花纸排版数量：个/版）</span></div>
                <div>= <span class="font-medium text-green-600">` + data.singleLabelPrice.toFixed(4) + ` 元/个</span><span class="text-gray-500 ml-1">（单个花纸价格）</span></div>
                
                <div class="font-medium mt-3">5. 单个花纸价格（实际金膜用量）计算：</div>
                <div>= ` + data.singlePaperPriceActual.toFixed(2) + `<span class="text-gray-500 ml-1">（单张纸成本：元/张）</span> ÷ ` + data.layoutCount + `<span class="text-gray-500 ml-1">（花纸排版数量：个/版）</span></div>
                <div>= <span class="font-medium text-purple-600">` + data.singleLabelPriceActual.toFixed(4) + ` 元/个</span><span class="text-gray-500 ml-1">（单个花纸价格：实际金膜用量）</span></div>
            `;
            
            calculationProcess += `
                </div>
            `;
            document.getElementById('pdfCalculationProcess').innerHTML = calculationProcess;
            
            // 更新单张纸价格
            document.getElementById('pdfSinglePaperPrice').textContent = data.singlePaperPrice.toFixed(2);
            document.getElementById('pdfSinglePaperPriceActual').textContent = data.singlePaperPriceActual.toFixed(2);
            document.getElementById('pdfTotalPaperCostDetail').textContent = data.singlePaperPrice.toFixed(2) + ' 元';
            
            // 更新单个花纸价格
            document.getElementById('pdfSingleLabelPrice').textContent = data.singleLabelPrice.toFixed(4);
            document.getElementById('pdfSingleLabelPriceActual').textContent = data.singleLabelPriceActual.toFixed(4);
            document.getElementById('pdfSingleLabelPriceDetail').textContent = data.singleLabelPrice.toFixed(4) + ' 元';
            
            // 更新计算明细（显示总成本）
            document.getElementById('pdfTotalInkCost').textContent = data.totalInkCost.toFixed(2) + ' 元';
            document.getElementById('pdfLaborCostDetail').textContent = data.totalLaborCost.toFixed(2) + ' 元';
            document.getElementById('pdfGoldFilmCost').textContent = data.totalGoldFilmCost.toFixed(2) + ' 元';
            document.getElementById('pdfActualGoldFilmCost').textContent = data.actualGoldFilmCost.toFixed(2) + ' 元';
            
            console.log('总成本明细：');
            console.log('- 油墨总成本:', data.totalInkCost);
            console.log('- 人工水电总成本:', data.totalLaborCost);
            console.log('- 金膜总成本:', data.totalGoldFilmCost);
            console.log('- 金膜实际成本:', data.actualGoldFilmCost);
            
            console.log('单张纸成本明细：');
            console.log('- 油墨成本/张:', data.totalInkCost / data.totalPaperUsage);
            console.log('- 人工水电/张:', data.totalLaborCost / data.totalPaperUsage);
            console.log('- 金膜成本/张:', data.totalGoldFilmCost / data.totalPaperUsage);
            console.log('- 实际金膜成本/张:', data.actualGoldFilmCost / data.totalPaperUsage);
            document.getElementById('pdfTotalPaperCostActualDetail').textContent = data.singlePaperPriceActual.toFixed(2) + ' 元';
            document.getElementById('pdfSingleLabelPriceActualDetail').textContent = data.singleLabelPriceActual.toFixed(4) + ' 元';
            document.getElementById('pdfLayoutCount').textContent = data.layoutCount + ' 个/版';
        }
        
        // 生成计算结果表格
        function generateCalculationTable() {
            const tableBody = document.getElementById('pdfCalculationTableBody');
            const tableFooter = document.getElementById('pdfCalculationTableFooter');
            
            // 清空表格
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';
            
            if (pdfCalculationResults.length === 0) {
                return;
            }
            
            // 计算总计
            let totalTotalArea = 0;
            let totalInkArea = 0;
            let totalInkWeight = 0;
            let totalCost = 0;
            let totalPaperCount = 0;
            let totalPaperCost = 0;
            
            // 创建排序后的结果数组
            const sortedResults = [...pdfCalculationResults].sort((a, b) => {
                // 优先按名称排序，"未识别成功"排在最后
                if (a.pageName === '未识别成功' && b.pageName !== '未识别成功') return 1;
                if (a.pageName !== '未识别成功' && b.pageName === '未识别成功') return -1;
                return a.pageName.localeCompare(b.pageName, 'zh-CN');
            });
            
            console.log('计算表格排序后的结果:', sortedResults);
            
            // 添加每一页的数据行（按排序后的顺序）
            sortedResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = result.pageNumber === currentPdfPage ? 'bg-blue-50' : '';
                
                // 计算总计
                totalTotalArea += result.totalArea;
                totalInkArea += result.inkArea;
                totalInkWeight += result.inkWeight * 1000;
                totalCost += result.inkCost;
                
                // 只在第一个页面计算纸张数量和成本（不考虑页面数量）
                if (index === 0) {
                    // 订单数量 ÷ 排版套数 × 纸张放数
                    const paperCount = (result.orderCount / result.layoutCount) * result.paperMultiplier;
                    totalPaperCount = paperCount;
                    const paperCost = paperCount * result.paperPrice;
                    totalPaperCost = paperCost;
                }
                
                // 页面尺寸显示为 "500.00 × 600.00 mm" 格式
                const actualSize = result.actualSize.replace(' × ', ' × ').replace('mm', ' mm');
                
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${result.pageName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${actualSize}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${result.totalArea.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${result.inkArea.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${result.coverage.toFixed(2)}%</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${(result.inkWeight * 1000).toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 font-medium">${result.inkCost.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 添加合计行
            const footerRow = document.createElement('tr');
            footerRow.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合计</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">-</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${totalTotalArea.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${totalInkArea.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${((totalInkArea / totalTotalArea) * 100).toFixed(2)}%</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${totalInkWeight.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-green-600">${totalCost.toFixed(2)}</td>

            `;
            
            tableFooter.appendChild(footerRow);
        }

        // 下载PDF结果
        function downloadPdfResult() {
            const currentResult = pdfCalculationResults.find(r => r.pageNumber === currentPdfPage);
            if (!currentResult) {
                showToast('未找到当前页面的计算结果', 'warning');
                return;
            }
            
            const resultText = `PDF页面成本测算结果
====================================
文件名称: ${currentResult.fileName}
页面名称: ${currentResult.pageName}
页码: ${currentResult.pageNumber}/${pdfDocument.numPages}
像素尺寸: ${currentResult.pixelSize}
实际尺寸: ${currentResult.actualSize}

面积信息:
- 总印刷面积: ${currentResult.totalArea.toFixed(2)} m²
- 油墨区域面积: ${currentResult.inkArea.toFixed(2)} m²
- 油墨覆盖率: ${currentResult.coverage.toFixed(2)}%

成本信息:
- 油墨使用量: ${(currentResult.inkWeight * 1000).toFixed(2)} g
- 单个体成本: ${currentResult.unitCost.toFixed(2)} 元
- 总订单成本: ${currentResult.inkCost.toFixed(2)} 元
- 排版数量: ${currentResult.layoutCount} 个/版
- 订单数量: ${currentResult.orderCount} 个

计算参数:
- 油墨价格: ${currentResult.inkPrice} 元/kg
- 覆盖面积: ${currentResult.inkCoverage} m²/kg

计算时间: ${new Date().toLocaleString('zh-CN')}
====================================`;
            
            downloadTextFile(`PDF页面_${currentResult.pageNumber}_成本测算结果.txt`, resultText);
        }

        // 打印PDF结果
        function printPdfResult() {
            const currentResult = pdfCalculationResults.find(r => r.pageNumber === currentPdfPage);
            if (!currentResult) {
                showToast('未找到当前页面的计算结果', 'warning');
                return;
            }
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h1 style="color: #1e40af; text-align: center; margin-bottom: 20px;">PDF页面成本测算结果</h1>
                    
                    <div style="background-color: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h2 style="color: #1e40af; margin-top: 0;">基本信息</h2>
                        <p><strong>文件名称:</strong> ${currentResult.fileName}</p>
                        <p><strong>页面名称:</strong> ${currentResult.pageName}</p>
                        <p><strong>页码:</strong> ${currentResult.pageNumber}/${pdfDocument.numPages}</p>
                        <p><strong>像素尺寸:</strong> ${currentResult.pixelSize}</p>
                        <p><strong>实际尺寸:</strong> ${currentResult.actualSize}</p>
                        <p><strong>计算时间:</strong> ${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                            <h2 style="color: #1e40af; margin-top: 0;">面积信息</h2>
                            <p><strong>总印刷面积:</strong> ${currentResult.totalArea.toFixed(2)} m²</p>
                            <p><strong>油墨区域面积:</strong> ${currentResult.inkArea.toFixed(2)} m²</p>
                            <p><strong>油墨覆盖率:</strong> ${currentResult.coverage.toFixed(2)}%</p>
                        </div>
                        
                        <div style="flex: 1; background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                            <h2 style="color: #1e40af; margin-top: 0;">成本信息</h2>
                            <p><strong>油墨使用量:</strong> ${(currentResult.inkWeight * 1000).toFixed(2)} g</p>
                            <p><strong>单个体成本:</strong> ${currentResult.unitCost.toFixed(2)} 元</p>
                            <p><strong>总订单成本:</strong> ${currentResult.inkCost.toFixed(2)} 元</p>
                            <p><strong>排版数量:</strong> ${currentResult.layoutCount} 个/版</p>
                            <p><strong>订单数量:</strong> ${currentResult.orderCount} 个</p>
                        </div>
                    </div>
                    
                    <div style="background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                        <h2 style="color: #1e40af; margin-top: 0;">计算参数</h2>
                        <p><strong>油墨价格:</strong> ${currentResult.inkPrice} 元/kg</p>
                        <p><strong>覆盖面积:</strong> ${currentResult.inkCoverage} m²/kg</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // 清空PDF结果
        function clearPdfResults() {
            pdfCalculationResults = [];
            document.getElementById('pdfCalculationDetails').classList.add('hidden');
            document.getElementById('pdfResults').classList.add('hidden');
            showToast('PDF结果已清空', 'success');
        }

        // 主题切换功能
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');
            
            if (isDark) {
                body.classList.remove('dark-theme');
                body.classList.remove('bg-gray-900');
                body.classList.add('bg-gray-50');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-theme');
                body.classList.remove('bg-gray-50');
                body.classList.add('bg-gray-900');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
    
    <!-- 简约页脚 -->
    <footer class="bg-white border-t border-gray-100 py-3 mt-6 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="text-center text-gray-400 text-xs">
                © 2024 海翔花纸成本测算系统
            </div>
        </div>
    </footer>
</body>
</html>